<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kafka æµç¨‹å›¾å¯è§†åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            color: #333;
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .diagram-section {
            margin-bottom: 60px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .diagram-section h2 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .diagram-container {
            background: white;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            margin-top: 20px;
        }

        .mermaid {
            text-align: center;
            min-height: 300px;
        }

        .description {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 6px;
            color: #555;
            line-height: 1.6;
        }

        .description h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .description ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .description li {
            margin-bottom: 8px;
        }

        .toc {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 40px;
        }

        .toc h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .toc ul {
            list-style: none;
        }

        .toc li {
            margin: 8px 0;
        }

        .toc a {
            color: #667eea;
            text-decoration: none;
            font-size: 1.05em;
            transition: color 0.3s;
        }

        .toc a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #e83e8c;
        }

        @media print {
            body {
                background: white;
            }
            .container {
                box-shadow: none;
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Kafka æµç¨‹å›¾å¯è§†åŒ–</h1>
        <p class="subtitle">Apache Kafka æ ¸å¿ƒæ¶æ„ä¸å·¥ä½œæµç¨‹å®Œæ•´å›¾è§£</p>

        <div class="toc">
            <h3>ğŸ“‘ ç›®å½•å¯¼èˆª</h3>
            <ul>
                <li><a href="#diagram1">1. Kafka æ•´ä½“æ¶æ„å›¾</a></li>
                <li><a href="#diagram2">2. Producer å‘é€æ¶ˆæ¯æµç¨‹</a></li>
                <li><a href="#diagram3">3. Consumer æ¶ˆè´¹æ¶ˆæ¯æµç¨‹</a></li>
                <li><a href="#diagram4">4. Topic å’Œ Partition åˆ†å¸ƒæµç¨‹</a></li>
                <li><a href="#diagram5">5. Consumer Group è´Ÿè½½å‡è¡¡æµç¨‹</a></li>
                <li><a href="#diagram6">6. æ¶ˆæ¯å­˜å‚¨å’ŒæŒä¹…åŒ–æµç¨‹</a></li>
                <li><a href="#diagram7">7. é«˜å¯ç”¨æ€§(HA)å’Œå®¹é”™æµç¨‹</a></li>
                <li><a href="#diagram8">8. å®Œæ•´çš„æ•°æ®æµå‘å›¾</a></li>
                <li><a href="#diagram9">9. KRaftæ¨¡å¼é«˜å¯ç”¨æ¶æ„ (Kafka 3.3+)</a></li>
                <li><a href="#diagram10">10. KRaft Controlleré€‰ä¸¾å’Œæ•…éšœè½¬ç§»æµç¨‹</a></li>
                <li><a href="#raft-algorithm">11. Raftç®—æ³•è¯¦è§£åŠå†…éƒ¨åŸç†</a></li>
                <li><a href="#zookeeper-algorithm">12. Zookeeperç®—æ³•è¯¦è§£åŠå†…éƒ¨åŸç†</a></li>
            </ul>
        </div>

        <!-- å›¾è¡¨1: Kafka æ•´ä½“æ¶æ„å›¾ -->
        <div class="diagram-section" id="diagram1">
            <h2>1. Kafka æ•´ä½“æ¶æ„å›¾</h2>
            <div class="diagram-container">
                <div class="mermaid">
graph TB
    subgraph "Producer ç”Ÿäº§è€…"
        P1[Producer 1]
        P2[Producer 2]
        P3[Producer 3]
    end
    
    subgraph "Kafka Cluster é›†ç¾¤"
        subgraph "Broker 1"
            B1[Broker 1]
            T1[Topic A<br/>Partition 0]
            T2[Topic A<br/>Partition 1]
            T3[Topic B<br/>Partition 0]
        end
        
        subgraph "Broker 2"
            B2[Broker 2]
            T4[Topic A<br/>Partition 2]
            T5[Topic B<br/>Partition 1]
        end
        
        subgraph "Broker 3"
            B3[Broker 3]
            T6[Topic B<br/>Partition 2]
        end
        
        ZK[Zookeeper<br/>åè°ƒæœåŠ¡]
    end
    
    subgraph "Consumer æ¶ˆè´¹è€…"
        CG1[Consumer Group 1]
        CG2[Consumer Group 2]
        C1[Consumer 1]
        C2[Consumer 2]
        C3[Consumer 3]
        C4[Consumer 4]
    end
    
    P1 -->|å‘é€æ¶ˆæ¯| B1
    P2 -->|å‘é€æ¶ˆæ¯| B2
    P3 -->|å‘é€æ¶ˆæ¯| B3
    
    B1 --> ZK
    B2 --> ZK
    B3 --> ZK
    
    CG1 --> C1
    CG1 --> C2
    CG2 --> C3
    CG2 --> C4
    
    C1 -->|æ¶ˆè´¹| B1
    C2 -->|æ¶ˆè´¹| B2
    C3 -->|æ¶ˆè´¹| B3
    C4 -->|æ¶ˆè´¹| B1
    
    style P1 fill:#e1f5ff
    style P2 fill:#e1f5ff
    style P3 fill:#e1f5ff
    style B1 fill:#fff4e1
    style B2 fill:#fff4e1
    style B3 fill:#fff4e1
    style C1 fill:#e8f5e9
    style C2 fill:#e8f5e9
    style C3 fill:#e8f5e9
    style C4 fill:#e8f5e9
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <p>å±•ç¤ºäº†Kafkaé›†ç¾¤çš„å®Œæ•´æ¶æ„ï¼ŒåŒ…æ‹¬Producerï¼ˆç”Ÿäº§è€…ï¼‰ã€Brokeré›†ç¾¤ã€Zookeeperåè°ƒæœåŠ¡ä»¥åŠConsumerï¼ˆæ¶ˆè´¹è€…ï¼‰ä¹‹é—´çš„å…³ç³»ã€‚ä¸åŒé¢œè‰²ä»£è¡¨ä¸åŒçš„ç»„ä»¶ç±»å‹ã€‚</p>
            </div>
        </div>

        <!-- å›¾è¡¨2: Producer å‘é€æ¶ˆæ¯æµç¨‹ -->
        <div class="diagram-section" id="diagram2">
            <h2>2. Producer å‘é€æ¶ˆæ¯æµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
sequenceDiagram
    participant App as åº”ç”¨ç¨‹åº
    participant P as Producer
    participant Ser as åºåˆ—åŒ–å™¨
    participant Part as åˆ†åŒºå™¨
    participant Buffer as æ¶ˆæ¯ç¼“å†²åŒº
    participant Net as ç½‘ç»œçº¿ç¨‹
    participant Broker as Kafka Broker
    
    App->>P: åˆ›å»ºProducerRecord
    P->>Ser: åºåˆ—åŒ–Keyå’ŒValue
    Ser->>Part: é€‰æ‹©åˆ†åŒº
    Part->>Buffer: æ·»åŠ åˆ°ç¼“å†²åŒº
    Buffer->>Buffer: æ‰¹é‡ç§¯ç´¯æ¶ˆæ¯
    Buffer->>Net: è¾¾åˆ°é˜ˆå€¼æˆ–è¶…æ—¶
    Net->>Net: æ„å»ºè¯·æ±‚
    Net->>Broker: å‘é€æ¶ˆæ¯æ‰¹æ¬¡
    Broker-->>Net: è¿”å›ç¡®è®¤(ACK)
    Net-->>P: å›è°ƒProducerCallback
    P-->>App: è¿”å›ç»“æœ
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <p>å±•ç¤ºäº†Producerå‘é€æ¶ˆæ¯çš„å®Œæ•´æµç¨‹ï¼šä»åº”ç”¨ç¨‹åºåˆ›å»ºæ¶ˆæ¯è®°å½•ï¼Œç»è¿‡åºåˆ—åŒ–ã€åˆ†åŒºé€‰æ‹©ã€æ‰¹é‡ç¼“å†²ï¼Œæœ€ç»ˆå‘é€åˆ°Kafka Brokerå¹¶è·å¾—ç¡®è®¤ã€‚</p>
            </div>
        </div>

        <!-- å›¾è¡¨3: Consumer æ¶ˆè´¹æ¶ˆæ¯æµç¨‹ -->
        <div class="diagram-section" id="diagram3">
            <h2>3. Consumer æ¶ˆè´¹æ¶ˆæ¯æµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
sequenceDiagram
    participant App as åº”ç”¨ç¨‹åº
    participant C as Consumer
    participant CG as ConsumerGroupåè°ƒå™¨
    participant Broker as Kafka Broker
    
    App->>C: åˆ›å»ºConsumerå¹¶è®¢é˜…Topic
    C->>CG: åŠ å…¥Consumer Group
    CG->>CG: è¿›è¡ŒRebalance
    CG-->>C: åˆ†é…Partition
    C->>Broker: æ‹‰å–æ¶ˆæ¯(FetchRequest)
    Broker-->>C: è¿”å›æ¶ˆæ¯æ‰¹æ¬¡
    C->>C: å¤„ç†æ¶ˆæ¯
    C->>Broker: æäº¤Offset(è‡ªåŠ¨/æ‰‹åŠ¨)
    Broker-->>C: ç¡®è®¤Offsetæäº¤
    C-->>App: è¿”å›æ¶ˆè´¹ç»“æœ
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <p>å±•ç¤ºäº†Consumeræ¶ˆè´¹æ¶ˆæ¯çš„å®Œæ•´æµç¨‹ï¼šè®¢é˜…Topicã€åŠ å…¥Consumer Groupã€è¿›è¡ŒRebalanceåˆ†é…Partitionã€æ‹‰å–æ¶ˆæ¯ã€å¤„ç†æ¶ˆæ¯å¹¶æäº¤Offsetã€‚</p>
            </div>
        </div>

        <!-- å›¾è¡¨4: Topic å’Œ Partition åˆ†å¸ƒæµç¨‹ -->
        <div class="diagram-section" id="diagram4">
            <h2>4. Topic å’Œ Partition åˆ†å¸ƒæµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
graph LR
    subgraph "Topic: orders"
        P0[Partition 0<br/>Leader: Broker1<br/>Replicas: B1,B2,B3]
        P1[Partition 1<br/>Leader: Broker2<br/>Replicas: B2,B3,B1]
        P2[Partition 2<br/>Leader: Broker3<br/>Replicas: B3,B1,B2]
    end
    
    Producer[Producer] -->|æ¶ˆæ¯1| P0
    Producer -->|æ¶ˆæ¯2| P1
    Producer -->|æ¶ˆæ¯3| P2
    
    P0 -->|å¤åˆ¶| Follower1[Followerå‰¯æœ¬]
    P1 -->|å¤åˆ¶| Follower2[Followerå‰¯æœ¬]
    P2 -->|å¤åˆ¶| Follower3[Followerå‰¯æœ¬]
    
    Consumer[Consumer Group] -->|æ¶ˆè´¹| P0
    Consumer -->|æ¶ˆè´¹| P1
    Consumer -->|æ¶ˆè´¹| P2
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <p>å±•ç¤ºäº†Topicå¦‚ä½•è¢«åˆ†å‰²ä¸ºå¤šä¸ªPartitionï¼Œæ¯ä¸ªPartitionçš„Leaderå’ŒReplicasåˆ†å¸ƒï¼Œä»¥åŠProducerå’ŒConsumerå¦‚ä½•ä¸Partitionäº¤äº’ã€‚</p>
            </div>
        </div>

        <!-- å›¾è¡¨5: Consumer Group è´Ÿè½½å‡è¡¡æµç¨‹ -->
        <div class="diagram-section" id="diagram5">
            <h2>5. Consumer Group è´Ÿè½½å‡è¡¡æµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
graph TD
    Start[Consumer Groupå¯åŠ¨] --> Join[æ¶ˆè´¹è€…åŠ å…¥Group]
    Join --> Elect[é€‰ä¸¾Group Coordinator]
    Elect --> JoinReq[å‘é€JoinGroupè¯·æ±‚]
    JoinReq --> Wait[ç­‰å¾…æ‰€æœ‰æ¶ˆè´¹è€…åŠ å…¥]
    Wait --> Rebalance{å¼€å§‹Rebalance}
    
    Rebalance --> Assign[Coordinatoråˆ†é…Partition]
    Assign --> Sync[å‘é€SyncGroupè¯·æ±‚]
    Sync --> Consume[å¼€å§‹æ¶ˆè´¹åˆ†é…åˆ°çš„Partition]
    
    Consume --> Check{æœ‰æ–°ConsumeråŠ å…¥<br/>æˆ–Consumerç¦»å¼€?}
    Check -->|æ˜¯| Rebalance
    Check -->|å¦| Continue[ç»§ç»­æ¶ˆè´¹]
    Continue --> Check
    
    style Rebalance fill:#ffeb3b
    style Consume fill:#4caf50
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <p>å±•ç¤ºäº†Consumer Groupçš„è´Ÿè½½å‡è¡¡æœºåˆ¶ï¼ˆRebalanceï¼‰ï¼ŒåŒ…æ‹¬ConsumeråŠ å…¥ã€Partitionåˆ†é…ã€ä»¥åŠåŠ¨æ€è°ƒæ•´çš„è¿‡ç¨‹ã€‚</p>
            </div>
        </div>

        <!-- å›¾è¡¨6: æ¶ˆæ¯å­˜å‚¨å’ŒæŒä¹…åŒ–æµç¨‹ -->
        <div class="diagram-section" id="diagram6">
            <h2>6. æ¶ˆæ¯å­˜å‚¨å’ŒæŒä¹…åŒ–æµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
graph LR
    subgraph "Kafka Broker"
        Receive[æ¥æ”¶æ¶ˆæ¯] --> Validate[éªŒè¯æ¶ˆæ¯]
        Validate --> Append[è¿½åŠ åˆ°Logæ–‡ä»¶]
        Append --> Index[æ›´æ–°ç´¢å¼•æ–‡ä»¶]
        Index --> Replicate[å¤åˆ¶åˆ°Follower]
        Replicate --> Flush[åˆ·æ–°åˆ°ç£ç›˜]
        Flush --> Commit[æäº¤Offset]
    end
    
    Append --> LogFile[Segment Log<br/>.logæ–‡ä»¶]
    Index --> IndexFile[Offset Index<br/>.indexæ–‡ä»¶]
    Index --> TimeIndex[Time Index<br/>.timeindexæ–‡ä»¶]
    
    style Append fill:#2196f3
    style Replicate fill:#ff9800
    style Flush fill:#4caf50
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <p>å±•ç¤ºäº†Kafka Brokerå¦‚ä½•å­˜å‚¨å’ŒæŒä¹…åŒ–æ¶ˆæ¯ï¼šæ¥æ”¶æ¶ˆæ¯åè¿½åŠ åˆ°Logæ–‡ä»¶ï¼Œæ›´æ–°ç´¢å¼•æ–‡ä»¶ï¼Œå¤åˆ¶åˆ°Followerå‰¯æœ¬ï¼Œæœ€ååˆ·æ–°åˆ°ç£ç›˜ã€‚</p>
            </div>
        </div>

        <!-- å›¾è¡¨7: é«˜å¯ç”¨æ€§(HA)å’Œå®¹é”™æµç¨‹ -->
        <div class="diagram-section" id="diagram7">
            <h2>7. é«˜å¯ç”¨æ€§(HA)å’Œå®¹é”™æµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
graph TD
    Start[æ­£å¸¸çŠ¶æ€] --> Leader[Leaderå¤„ç†è¯·æ±‚]
    Leader --> Follower[FolloweråŒæ­¥æ•°æ®]
    
    Leader --> Monitor[ç›‘æ§Leaderå¥åº·çŠ¶æ€]
    Monitor --> Check{Leaderæ˜¯å¦å­˜æ´»?}
    
    Check -->|æ˜¯| Continue[ç»§ç»­è¿è¡Œ]
    Check -->|å¦| Detect[æ£€æµ‹åˆ°Leaderæ•…éšœ]
    
    Detect --> Elect[ä»ISRä¸­é€‰æ‹©æ–°Leader]
    Elect --> Update[æ›´æ–°å…ƒæ•°æ®]
    Update --> Recover[æ¢å¤æœåŠ¡]
    Recover --> NewLeader[æ–°Leaderå¼€å§‹æœåŠ¡]
    
    Continue --> Monitor
    
    style Detect fill:#f44336
    style Elect fill:#ff9800
    style NewLeader fill:#4caf50
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <p>å±•ç¤ºäº†Kafkaçš„é«˜å¯ç”¨æ€§æœºåˆ¶ï¼šå½“Leader Brokeræ•…éšœæ—¶ï¼Œä»ISRï¼ˆIn-Sync Replicasï¼‰ä¸­é€‰æ‹©æ–°çš„Leaderï¼Œç¡®ä¿æœåŠ¡ä¸ä¸­æ–­ã€‚</p>
            </div>
        </div>

        <!-- å›¾è¡¨8: å®Œæ•´çš„æ•°æ®æµå‘å›¾ -->
        <div class="diagram-section" id="diagram8">
            <h2>8. å®Œæ•´çš„æ•°æ®æµå‘å›¾</h2>
            <div class="diagram-container">
                <div class="mermaid">
flowchart TD
    subgraph "æ•°æ®æº"
        Source1[æ•°æ®æº1]
        Source2[æ•°æ®æº2]
        Source3[æ•°æ®æº3]
    end
    
    subgraph "Kafka Cluster"
        subgraph "Topic A"
            PA1[Partition 0]
            PA2[Partition 1]
            PA3[Partition 2]
        end
        
        subgraph "Topic B"
            PB1[Partition 0]
            PB2[Partition 1]
        end
    end
    
    subgraph "æ•°æ®æ¶ˆè´¹"
        Stream1[æµå¤„ç†åº”ç”¨]
        DB1[æ•°æ®åº“]
        Cache1[ç¼“å­˜ç³»ç»Ÿ]
        Monitor1[ç›‘æ§ç³»ç»Ÿ]
    end
    
    Source1 -->|Producerå‘é€| PA1
    Source2 -->|Producerå‘é€| PA2
    Source3 -->|Producerå‘é€| PA3
    
    PA1 -->|Consumeræ¶ˆè´¹| Stream1
    PA2 -->|Consumeræ¶ˆè´¹| DB1
    PA3 -->|Consumeræ¶ˆè´¹| Cache1
    
    PB1 -->|Consumeræ¶ˆè´¹| Monitor1
    PB2 -->|Consumeræ¶ˆè´¹| Stream1
    
    style Source1 fill:#e3f2fd
    style Source2 fill:#e3f2fd
    style Source3 fill:#e3f2fd
    style Stream1 fill:#e8f5e9
    style DB1 fill:#e8f5e9
    style Cache1 fill:#e8f5e9
    style Monitor1 fill:#e8f5e9
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <p>å±•ç¤ºäº†Kafkaåœ¨å…¸å‹åº”ç”¨åœºæ™¯ä¸­çš„å®Œæ•´æ•°æ®æµå‘ï¼šä»å¤šä¸ªæ•°æ®æºé€šè¿‡Producerå‘é€åˆ°ä¸åŒçš„Topicå’ŒPartitionï¼Œç„¶åè¢«ä¸åŒçš„Consumer Groupæ¶ˆè´¹å¹¶åˆ†å‘åˆ°å„ç§ä¸‹æ¸¸ç³»ç»Ÿã€‚</p>
            </div>
        </div>

        <!-- å›¾è¡¨9: KRaftæ¨¡å¼é«˜å¯ç”¨æ¶æ„ -->
        <div class="diagram-section" id="diagram9">
            <h2>9. KRaftæ¨¡å¼é«˜å¯ç”¨æ¶æ„ (Kafka 3.3+)</h2>
            <div class="diagram-container">
                <div class="mermaid">
graph TB
    subgraph "Producer ç”Ÿäº§è€…"
        P1[Producer 1]
        P2[Producer 2]
    end
    
    subgraph "Kafka Cluster KRaftæ¨¡å¼"
        subgraph "Controller Quorum æ§åˆ¶å™¨ä»²è£ç»„"
            C1[Controller 1<br/>Active Leader<br/>å¤„ç†å…ƒæ•°æ®è¯·æ±‚]
            C2[Controller 2<br/>Standby Follower]
            C3[Controller 3<br/>Standby Follower]
        end
        
        MetadataLog[Metadata Log<br/>__cluster_metadata<br/>å…ƒæ•°æ®æ—¥å¿—Topic]
        
        subgraph "Broker èŠ‚ç‚¹ (æ•°æ®èŠ‚ç‚¹)"
            B1[Broker 1<br/>å­˜å‚¨æ•°æ®Partition]
            B2[Broker 2<br/>å­˜å‚¨æ•°æ®Partition]
            B3[Broker 3<br/>å­˜å‚¨æ•°æ®Partition]
        end
        
        subgraph "Topicåˆ†åŒºç¤ºä¾‹"
            TP1[Topic A<br/>Partition 0<br/>Leader: B1]
            TP2[Topic A<br/>Partition 1<br/>Leader: B2]
            TP3[Topic B<br/>Partition 0<br/>Leader: B3]
        end
    end
    
    subgraph "Consumer æ¶ˆè´¹è€…"
        CG[Consumer Group]
        Cons1[Consumer 1]
        Cons2[Consumer 2]
    end
    
    P1 -->|å‘é€æ¶ˆæ¯| B1
    P2 -->|å‘é€æ¶ˆæ¯| B2
    
    C1 -->|å†™å…¥å…ƒæ•°æ®å˜æ›´| MetadataLog
    C2 -->|åŒæ­¥è¯»å–| MetadataLog
    C3 -->|åŒæ­¥è¯»å–| MetadataLog
    
    C1 -->|ç®¡ç†Partitionåˆ†é…| B1
    C1 -->|ç®¡ç†Partitionåˆ†é…| B2
    C1 -->|ç®¡ç†Partitionåˆ†é…| B3
    C1 -->|ç®¡ç†Topicåˆ›å»º/åˆ é™¤| MetadataLog
    
    B1 --> TP1
    B2 --> TP2
    B3 --> TP3
    
    CG --> Cons1
    CG --> Cons2
    Cons1 -->|æ¶ˆè´¹| B1
    Cons2 -->|æ¶ˆè´¹| B2
    
    style C1 fill:#ff6b6b
    style C2 fill:#ffd93d
    style C3 fill:#ffd93d
    style MetadataLog fill:#a8e6cf
    style B1 fill:#fff4e1
    style B2 fill:#fff4e1
    style B3 fill:#fff4e1
    style P1 fill:#e1f5ff
    style P2 fill:#e1f5ff
    style Cons1 fill:#e8f5e9
    style Cons2 fill:#e8f5e9
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <p><strong>KRaftæ¨¡å¼ (Kafka Raft)</strong>æ˜¯Kafka 3.3+ç‰ˆæœ¬å¼•å…¥çš„æ–°æ¶æ„ï¼Œå®Œå…¨ç§»é™¤äº†å¯¹Zookeeperçš„ä¾èµ–ã€‚æ ¸å¿ƒç‰¹ç‚¹ï¼š</p>
                <ul>
                    <li><strong>Controller Quorum</strong>ï¼šç”±å¤šä¸ªControllerèŠ‚ç‚¹ç»„æˆä»²è£ç»„ï¼Œä½¿ç”¨Raftå…±è¯†ç®—æ³•é€‰ä¸¾Leader</li>
                    <li><strong>Metadata Log</strong>ï¼šå…ƒæ•°æ®å­˜å‚¨åœ¨Kafkaå†…éƒ¨çš„ç‰¹æ®ŠTopicï¼ˆ__cluster_metadataï¼‰ä¸­ï¼Œè€Œä¸æ˜¯Zookeeper</li>
                    <li><strong>Active Leader</strong>ï¼šåªæœ‰ä¸€ä¸ªControllerä½œä¸ºLeaderå¤„ç†å…ƒæ•°æ®è¯·æ±‚</li>
                    <li><strong>Standby Followers</strong>ï¼šå…¶ä»–Controllerä½œä¸ºFolloweråŒæ­¥å…ƒæ•°æ®ï¼ŒLeaderæ•…éšœæ—¶è‡ªåŠ¨é€‰ä¸¾æ–°Leader</li>
                    <li><strong>BrokerèŠ‚ç‚¹</strong>ï¼šä¸“æ³¨äºæ•°æ®å­˜å‚¨å’Œå¤„ç†ï¼Œä¸å†éœ€è¦ä¸Zookeeperäº¤äº’</li>
                    <li><strong>ä¼˜åŠ¿</strong>ï¼šç®€åŒ–æ¶æ„ã€æé«˜æ€§èƒ½ã€æ”¯æŒæ›´å¤§è§„æ¨¡é›†ç¾¤ã€æ›´å¿«çš„æ•…éšœæ¢å¤</li>
                </ul>
            </div>
        </div>

        <!-- å›¾è¡¨10: KRaft Controlleré€‰ä¸¾å’Œæ•…éšœè½¬ç§»æµç¨‹ -->
        <div class="diagram-section" id="diagram10">
            <h2>10. KRaft Controlleré€‰ä¸¾å’Œæ•…éšœè½¬ç§»æµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
sequenceDiagram
    participant C1 as Controller 1<br/>(Leader)
    participant C2 as Controller 2<br/>(Follower)
    participant C3 as Controller 3<br/>(Follower)
    participant ML as Metadata Log
    participant B as BrokerèŠ‚ç‚¹
    
    Note over C1,ML: æ­£å¸¸è¿è¡Œæ—¶
    C1->>ML: å†™å…¥å…ƒæ•°æ®å˜æ›´
    C2->>ML: åŒæ­¥è¯»å–å…ƒæ•°æ®
    C3->>ML: åŒæ­¥è¯»å–å…ƒæ•°æ®
    C1->>B: å‘é€å…ƒæ•°æ®æ›´æ–°
    B-->>C1: ç¡®è®¤æ¥æ”¶
    
    Note over C1,C3: Controller Leaderæ•…éšœ
    C1-xC2: å¿ƒè·³è¶…æ—¶
    C1-xC3: å¿ƒè·³è¶…æ—¶
    C2->>C2: æ£€æµ‹åˆ°Leaderæ•…éšœ
    C3->>C3: æ£€æµ‹åˆ°Leaderæ•…éšœ
    
    Note over C2,C3: Rafté€‰ä¸¾æ–°Leader
    C2->>C3: å‘èµ·æŠ•ç¥¨è¯·æ±‚
    C3->>C2: æŠ•ç¥¨ç»™C2
    C2->>C2: è·å¾—å¤šæ•°ç¥¨ï¼Œæˆä¸ºæ–°Leader
    
    Note over C2,ML: æ–°Leaderæ¥ç®¡
    C2->>ML: è¯»å–æœ€æ–°å…ƒæ•°æ®
    ML-->>C2: è¿”å›å…ƒæ•°æ®
    C2->>B: å¹¿æ’­æ–°çš„Leaderä¿¡æ¯
    B-->>C2: ç¡®è®¤æ›´æ–°
    C3->>C2: åŒæ­¥æ–°Leaderçš„å…ƒæ•°æ®
    
    Note over C2,B: æ¢å¤æ­£å¸¸æœåŠ¡
    C2->>ML: ç»§ç»­å†™å…¥å…ƒæ•°æ®å˜æ›´
    C2->>B: ç®¡ç†é›†ç¾¤å…ƒæ•°æ®
    C3->>ML: ç»§ç»­åŒæ­¥å…ƒæ•°æ®
                </div>
            </div>
            <div class="diagram-container" style="margin-top: 30px;">
                <div class="mermaid">
graph TD
    Start[Controller Quorumè¿è¡Œ] --> Leader[Controller Leader<br/>å¤„ç†å…ƒæ•°æ®è¯·æ±‚]
    Leader --> Write[å†™å…¥Metadata Log]
    Write --> Sync[Standby Controllers<br/>åŒæ­¥å…ƒæ•°æ®]
    Sync --> Monitor[ç›‘æ§Leaderå¥åº·]
    
    Monitor --> Check{Leaderæ˜¯å¦å­˜æ´»?}
    Check -->|æ˜¯| Continue[ç»§ç»­è¿è¡Œ]
    Check -->|å¦| Detect[æ£€æµ‹åˆ°Leaderæ•…éšœ]
    
    Detect --> Elect[Rafté€‰ä¸¾æœºåˆ¶]
    Elect --> Vote[å„ControlleræŠ•ç¥¨]
    Vote --> Majority{è·å¾—å¤šæ•°ç¥¨?}
    
    Majority -->|æ˜¯| NewLeader[æ–°Leaderå½“é€‰]
    Majority -->|å¦| Retry[é‡æ–°é€‰ä¸¾]
    Retry --> Vote
    
    NewLeader --> ReadMeta[è¯»å–Metadata Log<br/>æœ€æ–°å…ƒæ•°æ®]
    ReadMeta --> Broadcast[å¹¿æ’­æ–°Leaderä¿¡æ¯<br/>ç»™æ‰€æœ‰Broker]
    Broadcast --> Update[Brokeræ›´æ–°<br/>å…ƒæ•°æ®ç¼“å­˜]
    Update --> Service[æ¢å¤å…ƒæ•°æ®æœåŠ¡]
    
    Continue --> Monitor
    Service --> Write
    
    style Leader fill:#4caf50
    style Detect fill:#f44336
    style Elect fill:#ff9800
    style NewLeader fill:#2196f3
    style Service fill:#4caf50
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <p><strong>KRaftæ¨¡å¼çš„Controlleré€‰ä¸¾å’Œæ•…éšœè½¬ç§»æœºåˆ¶ï¼š</strong></p>
                <ul>
                    <li><strong>Raftå…±è¯†ç®—æ³•</strong>ï¼šä½¿ç”¨Raftç®—æ³•åœ¨Controller Quorumä¸­é€‰ä¸¾Leaderï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§</li>
                    <li><strong>å…ƒæ•°æ®å­˜å‚¨</strong>ï¼šæ‰€æœ‰å…ƒæ•°æ®å˜æ›´éƒ½å†™å…¥Metadata Logï¼ˆå†…éƒ¨Topicï¼‰ï¼Œä¿è¯æŒä¹…åŒ–å’Œå¯è¿½æº¯</li>
                    <li><strong>æ•…éšœæ£€æµ‹</strong>ï¼šé€šè¿‡å¿ƒè·³æœºåˆ¶æ£€æµ‹Leaderæ•…éšœï¼ŒFollower Controllersä¼šæ£€æµ‹åˆ°Leaderå¤±è”</li>
                    <li><strong>è‡ªåŠ¨é€‰ä¸¾</strong>ï¼šå½“Leaderæ•…éšœæ—¶ï¼Œå‰©ä½™Controllersé€šè¿‡Raftç®—æ³•è‡ªåŠ¨é€‰ä¸¾æ–°Leaderï¼ˆéœ€è¦è·å¾—å¤šæ•°ç¥¨ï¼‰</li>
                    <li><strong>å¿«é€Ÿæ¢å¤</strong>ï¼šæ–°Leaderä»Metadata Logè¯»å–æœ€æ–°å…ƒæ•°æ®ï¼Œå¹¿æ’­ç»™æ‰€æœ‰Brokerï¼Œå¿«é€Ÿæ¢å¤æœåŠ¡</li>
                    <li><strong>æ•°æ®ä¸€è‡´æ€§</strong>ï¼šé€šè¿‡Raftç®—æ³•ä¿è¯å…ƒæ•°æ®çš„ä¸€è‡´æ€§å’Œé¡ºåºæ€§ï¼Œé¿å…è„‘è£‚é—®é¢˜</li>
                    <li><strong>ä¼˜åŠ¿å¯¹æ¯”Zookeeper</strong>ï¼šæ›´å¿«çš„æ•…éšœæ¢å¤ï¼ˆç§’çº§ï¼‰ã€æ›´ç®€å•çš„éƒ¨ç½²ã€æ›´å¥½çš„æ€§èƒ½ã€æ”¯æŒæ›´å¤§è§„æ¨¡é›†ç¾¤</li>
                </ul>
                <p><strong>å…³é”®é…ç½®å‚æ•°ï¼š</strong></p>
                <ul>
                    <li><code>process.roles=controller,broker</code>ï¼šèŠ‚ç‚¹è§’è‰²ï¼ˆControllerã€Brokeræˆ–ä¸¤è€…ï¼‰</li>
                    <li><code>controller.quorum.voters</code>ï¼šController Quorumçš„æŠ•ç¥¨èŠ‚ç‚¹åˆ—è¡¨</li>
                    <li><code>metadata.log.dir</code>ï¼šMetadata Logå­˜å‚¨ç›®å½•</li>
                </ul>
            </div>
        </div>

        <!-- Raftç®—æ³•è¯¦è§£ -->
        <div class="diagram-section" id="raft-algorithm">
            <h2>11. Raftç®—æ³•è¯¦è§£åŠå†…éƒ¨åŸç†</h2>
            
            <div class="description">
                <h3>Raftç®—æ³•æ¦‚è¿°</h3>
                <p>Raftæ˜¯ä¸€ç§åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ï¼Œç”¨äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°æ—¥å¿—å¤åˆ¶å’ŒLeaderé€‰ä¸¾ã€‚Kafka KRaftæ¨¡å¼ä½¿ç”¨Raftç®—æ³•æ¥ç®¡ç†Controller Quorumï¼Œç¡®ä¿å…ƒæ•°æ®çš„ä¸€è‡´æ€§å’Œé«˜å¯ç”¨æ€§ã€‚</p>
            </div>

            <!-- Raftæ ¸å¿ƒæ¦‚å¿µ -->
            <div class="diagram-section" style="margin-top: 30px; padding: 20px;">
                <h3>Raftæ ¸å¿ƒæ¦‚å¿µ</h3>
                <div class="diagram-container">
                    <div class="mermaid">
graph TB
    subgraph "RaftèŠ‚ç‚¹çŠ¶æ€"
        Leader[Leader<br/>é¢†å¯¼è€…<br/>å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚]
        Follower[Follower<br/>è·Ÿéšè€…<br/>è¢«åŠ¨æ¥æ”¶æ—¥å¿—]
        Candidate[Candidate<br/>å€™é€‰è€…<br/>é€‰ä¸¾è¿‡ç¨‹ä¸­çš„ä¸´æ—¶çŠ¶æ€]
    end
    
    Leader -->|å¿ƒè·³è¶…æ—¶| Candidate
    Candidate -->|è·å¾—å¤šæ•°ç¥¨| Leader
    Candidate -->|å‘ç°å·²æœ‰Leader| Follower
    Leader -->|å¤±å»é¢†å¯¼æƒ| Follower
    Follower -->|é€‰ä¸¾è¶…æ—¶| Candidate
    
    style Leader fill:#4caf50
    style Follower fill:#2196f3
    style Candidate fill:#ff9800
                    </div>
                </div>
                <div class="description">
                    <ul>
                        <li><strong>Leaderï¼ˆé¢†å¯¼è€…ï¼‰</strong>ï¼šé›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ªLeaderï¼Œå¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè´Ÿè´£æ—¥å¿—å¤åˆ¶</li>
                        <li><strong>Followerï¼ˆè·Ÿéšè€…ï¼‰</strong>ï¼šè¢«åŠ¨æ¥æ”¶Leaderçš„æ—¥å¿—æ¡ç›®ï¼Œå“åº”Leaderçš„å¿ƒè·³</li>
                        <li><strong>Candidateï¼ˆå€™é€‰è€…ï¼‰</strong>ï¼šé€‰ä¸¾è¿‡ç¨‹ä¸­çš„ä¸´æ—¶çŠ¶æ€ï¼Œå°è¯•æˆä¸ºLeader</li>
                    </ul>
                </div>
            </div>

            <!-- Rafté€‰ä¸¾è¿‡ç¨‹ -->
            <div class="diagram-container" style="margin-top: 30px;">
                <h3>Raft Leaderé€‰ä¸¾è¿‡ç¨‹</h3>
                <div class="mermaid">
sequenceDiagram
    participant F1 as Follower 1
    participant F2 as Follower 2
    participant F3 as Follower 3
    participant F4 as Follower 4
    participant F5 as Follower 5
    
    Note over F1,F5: åˆå§‹çŠ¶æ€ï¼šæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯Follower
    Note over F1,F5: Leaderå¿ƒè·³è¶…æ—¶ï¼Œè§¦å‘é€‰ä¸¾
    
    F1->>F1: é€‰ä¸¾è¶…æ—¶ï¼Œè½¬ä¸ºCandidate
    F1->>F1: å¢åŠ ä»»æœŸå·(Term)
    F1->>F1: æŠ•ç¥¨ç»™è‡ªå·±
    F1->>F2: å‘é€RequestVoteè¯·æ±‚
    F1->>F3: å‘é€RequestVoteè¯·æ±‚
    F1->>F4: å‘é€RequestVoteè¯·æ±‚
    F1->>F5: å‘é€RequestVoteè¯·æ±‚
    
    F2->>F1: æŠ•ç¥¨ç»™F1
    F3->>F1: æŠ•ç¥¨ç»™F1
    F4->>F1: æŠ•ç¥¨ç»™F1
    F5->>F1: æ‹’ç»æŠ•ç¥¨ï¼ˆå·²æŠ•ç¥¨ç»™å…¶ä»–èŠ‚ç‚¹ï¼‰
    
    Note over F1: è·å¾—3ç¥¨ï¼ˆå¤šæ•°ç¥¨ï¼š5/2+1=3ï¼‰
    F1->>F1: æˆä¸ºLeader
    
    F1->>F2: å‘é€å¿ƒè·³(AppendEntries)
    F1->>F3: å‘é€å¿ƒè·³(AppendEntries)
    F1->>F4: å‘é€å¿ƒè·³(AppendEntries)
    F1->>F5: å‘é€å¿ƒè·³(AppendEntries)
    
    F2->>F1: ç¡®è®¤å¿ƒè·³
    F3->>F1: ç¡®è®¤å¿ƒè·³
    F4->>F1: ç¡®è®¤å¿ƒè·³
    F5->>F1: ç¡®è®¤å¿ƒè·³
                </div>
            </div>

            <!-- Raftæ—¥å¿—å¤åˆ¶ -->
            <div class="diagram-container" style="margin-top: 30px;">
                <h3>Raftæ—¥å¿—å¤åˆ¶è¿‡ç¨‹</h3>
                <div class="mermaid">
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant L as Leader
    participant F1 as Follower 1
    participant F2 as Follower 2
    participant F3 as Follower 3
    participant F4 as Follower 4
    
    Client->>L: æäº¤æ—¥å¿—æ¡ç›®
    L->>L: å°†æ—¥å¿—è¿½åŠ åˆ°æœ¬åœ°æ—¥å¿—
    L->>F1: AppendEntries(æ—¥å¿—æ¡ç›®)
    L->>F2: AppendEntries(æ—¥å¿—æ¡ç›®)
    L->>F3: AppendEntries(æ—¥å¿—æ¡ç›®)
    L->>F4: AppendEntries(æ—¥å¿—æ¡ç›®)
    
    F1->>F1: éªŒè¯æ—¥å¿—ä¸€è‡´æ€§
    F2->>F2: éªŒè¯æ—¥å¿—ä¸€è‡´æ€§
    F3->>F3: éªŒè¯æ—¥å¿—ä¸€è‡´æ€§
    F4->>F4: éªŒè¯æ—¥å¿—ä¸€è‡´æ€§
    
    F1->>L: æˆåŠŸå“åº”
    F2->>L: æˆåŠŸå“åº”
    F3->>L: æˆåŠŸå“åº”
    F4->>L: æˆåŠŸå“åº”ï¼ˆå»¶è¿Ÿï¼‰
    
    Note over L: æ”¶åˆ°å¤šæ•°èŠ‚ç‚¹ç¡®è®¤ï¼ˆ3/5ï¼‰
    L->>L: æäº¤æ—¥å¿—æ¡ç›®
    L->>Client: è¿”å›æˆåŠŸ
    
    L->>F1: é€šçŸ¥æäº¤ï¼ˆä¸‹ä¸€æ¬¡å¿ƒè·³ï¼‰
    L->>F2: é€šçŸ¥æäº¤
    L->>F3: é€šçŸ¥æäº¤
    L->>F4: é€šçŸ¥æäº¤
    
    F1->>F1: æäº¤æ—¥å¿—æ¡ç›®
    F2->>F2: æäº¤æ—¥å¿—æ¡ç›®
    F3->>F3: æäº¤æ—¥å¿—æ¡ç›®
    F4->>F4: æäº¤æ—¥å¿—æ¡ç›®ï¼ˆå»¶è¿Ÿæäº¤ï¼‰
                </div>
            </div>

            <!-- Raftæ—¥å¿—ç»“æ„ -->
            <div class="diagram-container" style="margin-top: 30px;">
                <h3>Raftæ—¥å¿—ç»“æ„</h3>
                <div class="mermaid">
graph LR
    subgraph "Leaderæ—¥å¿—"
        L1[Index: 1<br/>Term: 1<br/>Cmd: x=1]
        L2[Index: 2<br/>Term: 1<br/>Cmd: y=2]
        L3[Index: 3<br/>Term: 2<br/>Cmd: z=3]
        L4[Index: 4<br/>Term: 2<br/>Cmd: w=4]
    end
    
    subgraph "Follower 1æ—¥å¿—"
        F1_1[Index: 1<br/>Term: 1<br/>Cmd: x=1]
        F1_2[Index: 2<br/>Term: 1<br/>Cmd: y=2]
        F1_3[Index: 3<br/>Term: 2<br/>Cmd: z=3]
    end
    
    subgraph "Follower 2æ—¥å¿—"
        F2_1[Index: 1<br/>Term: 1<br/>Cmd: x=1]
        F2_2[Index: 2<br/>Term: 1<br/>Cmd: y=2]
        F2_3[Index: 3<br/>Term: 1<br/>Cmd: old_z]
    end
    
    L1 -.->|åŒ¹é…| F1_1
    L2 -.->|åŒ¹é…| F1_2
    L3 -.->|åŒ¹é…| F1_3
    L4 -.->|æœªæäº¤| F1_4[ç©º]
    
    L1 -.->|åŒ¹é…| F2_1
    L2 -.->|åŒ¹é…| F2_2
    L3 -.->|å†²çª| F2_3
    
    Note1[Leaderéœ€è¦è¦†ç›–Follower 2çš„Index 3]
    
    style L4 fill:#ffeb3b
    style F2_3 fill:#f44336
                </div>
            </div>

            <!-- Raftå®‰å…¨æ€§ä¿è¯ -->
            <div class="diagram-container" style="margin-top: 30px;">
                <h3>Raftå®‰å…¨æ€§ä¿è¯æœºåˆ¶</h3>
                <div class="mermaid">
graph TD
    Start[Raftå®‰å…¨æ€§ä¿è¯] --> E1[é€‰ä¸¾å®‰å…¨æ€§<br/>æ¯ä¸ªä»»æœŸæœ€å¤šä¸€ä¸ªLeader]
    Start --> E2[æ—¥å¿—åŒ¹é…æ€§<br/>ä¸åŒèŠ‚ç‚¹çš„æ—¥å¿—åœ¨ç›¸åŒç´¢å¼•ä½ç½®<br/>å¦‚æœTermç›¸åŒåˆ™å†…å®¹ç›¸åŒ]
    Start --> E3[é¢†å¯¼è€…å®Œæ•´æ€§<br/>å·²æäº¤çš„æ—¥å¿—æ¡ç›®<br/>å¿…é¡»å‡ºç°åœ¨æ–°Leaderçš„æ—¥å¿—ä¸­]
    Start --> E4[çŠ¶æ€æœºå®‰å…¨æ€§<br/>ä¸åŒèŠ‚ç‚¹çš„çŠ¶æ€æœº<br/>æŒ‰ç›¸åŒé¡ºåºæ‰§è¡Œç›¸åŒå‘½ä»¤]
    
    E1 --> Rule1[æŠ•ç¥¨è§„åˆ™ï¼šCandidateå¿…é¡»<br/>åŒ…å«æ‰€æœ‰å·²æäº¤çš„æ—¥å¿—æ¡ç›®]
    E2 --> Rule2[æ—¥å¿—ä¸€è‡´æ€§æ£€æŸ¥ï¼šAppendEntries<br/>åŒ…å«å‰ä¸€æ¡æ—¥å¿—çš„Termå’ŒIndex]
    E3 --> Rule3[é€‰ä¸¾é™åˆ¶ï¼šåªæœ‰åŒ…å«<br/>æ‰€æœ‰å·²æäº¤æ—¥å¿—çš„èŠ‚ç‚¹æ‰èƒ½æˆä¸ºLeader]
    E4 --> Rule4[æäº¤è§„åˆ™ï¼šåªæœ‰å½“å‰ä»»æœŸçš„<br/>æ—¥å¿—æ¡ç›®æ‰èƒ½è¢«æäº¤]
    
    style E1 fill:#4caf50
    style E2 fill:#2196f3
    style E3 fill:#ff9800
    style E4 fill:#9c27b0
                </div>
            </div>

            <div class="description" style="margin-top: 30px;">
                <h3>Raftç®—æ³•å…³é”®ç‰¹æ€§</h3>
                <ul>
                    <li><strong>å¼ºä¸€è‡´æ€§</strong>ï¼šé€šè¿‡å¤šæ•°æ´¾æŠ•ç¥¨ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Œé¿å…è„‘è£‚</li>
                    <li><strong>å¯ç†è§£æ€§</strong>ï¼šç®—æ³•è®¾è®¡æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œå®ç°</li>
                    <li><strong>Leaderé€‰ä¸¾</strong>ï¼šä½¿ç”¨éšæœºè¶…æ—¶æœºåˆ¶é¿å…é€‰ä¸¾å†²çª</li>
                    <li><strong>æ—¥å¿—å¤åˆ¶</strong>ï¼šLeaderè´Ÿè´£æ—¥å¿—å¤åˆ¶ï¼ŒFollowerè¢«åŠ¨æ¥æ”¶</li>
                    <li><strong>æ•…éšœæ¢å¤</strong>ï¼šLeaderæ•…éšœæ—¶è‡ªåŠ¨é€‰ä¸¾æ–°Leaderï¼Œå¿«é€Ÿæ¢å¤æœåŠ¡</li>
                    <li><strong>æ—¥å¿—å‹ç¼©</strong>ï¼šæ”¯æŒå¿«ç…§æœºåˆ¶ï¼Œé¿å…æ—¥å¿—æ— é™å¢é•¿</li>
                </ul>

                <h3>Raftç®—æ³•å…³é”®å‚æ•°</h3>
                <ul>
                    <li><strong>Termï¼ˆä»»æœŸï¼‰</strong>ï¼šå•è°ƒé€’å¢çš„æ•´æ•°ï¼Œç”¨äºæ ‡è¯†Leaderçš„ä»»æœŸ</li>
                    <li><strong>CommitIndex</strong>ï¼šå·²æäº¤çš„æœ€å¤§æ—¥å¿—ç´¢å¼•</li>
                    <li><strong>LastApplied</strong>ï¼šå·²åº”ç”¨åˆ°çŠ¶æ€æœºçš„æœ€å¤§æ—¥å¿—ç´¢å¼•</li>
                    <li><strong>NextIndex</strong>ï¼šLeaderä¸ºæ¯ä¸ªFollowerç»´æŠ¤çš„ä¸‹ä¸€æ¡è¦å‘é€çš„æ—¥å¿—ç´¢å¼•</li>
                    <li><strong>MatchIndex</strong>ï¼šLeaderä¸ºæ¯ä¸ªFollowerç»´æŠ¤çš„å·²åŒ¹é…çš„æœ€å¤§æ—¥å¿—ç´¢å¼•</li>
                </ul>

                <h3>Raftåœ¨Kafka KRaftä¸­çš„åº”ç”¨</h3>
                <ul>
                    <li><strong>Controlleré€‰ä¸¾</strong>ï¼šä½¿ç”¨Raftç®—æ³•åœ¨Controller Quorumä¸­é€‰ä¸¾Leader</li>
                    <li><strong>å…ƒæ•°æ®ç®¡ç†</strong>ï¼šæ‰€æœ‰å…ƒæ•°æ®å˜æ›´é€šè¿‡Raftç®—æ³•å¤åˆ¶åˆ°æ‰€æœ‰ControllerèŠ‚ç‚¹</li>
                    <li><strong>Metadata Log</strong>ï¼šå…ƒæ•°æ®å­˜å‚¨åœ¨Kafkaå†…éƒ¨çš„ç‰¹æ®ŠTopicï¼Œä½¿ç”¨Raftç®—æ³•ä¿è¯ä¸€è‡´æ€§</li>
                    <li><strong>æ•…éšœè½¬ç§»</strong>ï¼šController Leaderæ•…éšœæ—¶ï¼Œé€šè¿‡Raftç®—æ³•å¿«é€Ÿé€‰ä¸¾æ–°Leader</li>
                </ul>
            </div>
        </div>

        <!-- Zookeeperç®—æ³•è¯¦è§£ -->
        <div class="diagram-section" id="zookeeper-algorithm">
            <h2>12. Zookeeperç®—æ³•è¯¦è§£åŠå†…éƒ¨åŸç†</h2>
            
            <div class="description">
                <h3>Zookeeperæ¦‚è¿°</h3>
                <p>Zookeeperæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œä¸ºåˆ†å¸ƒå¼åº”ç”¨æä¾›ä¸€è‡´æ€§æœåŠ¡ã€‚Kafkaåœ¨3.3ç‰ˆæœ¬ä¹‹å‰ä½¿ç”¨Zookeeperæ¥ç®¡ç†é›†ç¾¤å…ƒæ•°æ®ã€Controlleré€‰ä¸¾å’Œé…ç½®ä¿¡æ¯ã€‚Zookeeperä½¿ç”¨ZABï¼ˆZookeeper Atomic Broadcastï¼‰åè®®æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚</p>
            </div>

            <!-- ZABåè®®æ ¸å¿ƒæ¦‚å¿µ -->
            <div class="diagram-section" style="margin-top: 30px; padding: 20px;">
                <h3>ZABåè®®æ ¸å¿ƒæ¦‚å¿µ</h3>
                <div class="diagram-container">
                    <div class="mermaid">
graph TB
    subgraph "ZookeeperèŠ‚ç‚¹çŠ¶æ€"
        Leading[Leading<br/>é¢†å¯¼è€…<br/>å¤„ç†æ‰€æœ‰å†™è¯·æ±‚]
        Following[Following<br/>è·Ÿéšè€…<br/>æ¥æ”¶Leaderçš„å†™è¯·æ±‚]
        Observing[Observing<br/>è§‚å¯Ÿè€…<br/>ä¸å‚ä¸æŠ•ç¥¨ï¼ŒåªåŒæ­¥æ•°æ®]
        Looking[Looking<br/>å¯»æ‰¾Leader<br/>é€‰ä¸¾è¿‡ç¨‹ä¸­çš„çŠ¶æ€]
    end
    
    Looking -->|é€‰ä¸¾æˆåŠŸ| Leading
    Looking -->|å‘ç°Leader| Following
    Leading -->|å¤±å»é¢†å¯¼æƒ| Looking
    Following -->|Leaderæ•…éšœ| Looking
    Observing -->|å§‹ç»ˆè§‚å¯Ÿ| Observing
    
    style Leading fill:#4caf50
    style Following fill:#2196f3
    style Looking fill:#ff9800
    style Observing fill:#9e9e9e
                    </div>
                </div>
                <div class="description">
                    <ul>
                        <li><strong>Leadingï¼ˆé¢†å¯¼è€…ï¼‰</strong>ï¼šé›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ªLeaderï¼Œå¤„ç†æ‰€æœ‰å†™è¯·æ±‚ï¼Œè´Ÿè´£äº‹åŠ¡å¹¿æ’­</li>
                        <li><strong>Followingï¼ˆè·Ÿéšè€…ï¼‰</strong>ï¼šå‚ä¸æŠ•ç¥¨å’Œé€‰ä¸¾ï¼Œæ¥æ”¶Leaderçš„äº‹åŠ¡ææ¡ˆï¼Œå‚ä¸äº‹åŠ¡æäº¤</li>
                        <li><strong>Observingï¼ˆè§‚å¯Ÿè€…ï¼‰</strong>ï¼šä¸å‚ä¸æŠ•ç¥¨ï¼ŒåªåŒæ­¥æ•°æ®ï¼Œæé«˜è¯»æ€§èƒ½</li>
                        <li><strong>Lookingï¼ˆå¯»æ‰¾Leaderï¼‰</strong>ï¼šé€‰ä¸¾è¿‡ç¨‹ä¸­çš„çŠ¶æ€ï¼Œå°è¯•é€‰ä¸¾æˆ–å‘ç°Leader</li>
                    </ul>
                </div>
            </div>

            <!-- ZABé€‰ä¸¾è¿‡ç¨‹ -->
            <div class="diagram-container" style="margin-top: 30px;">
                <h3>ZAB Leaderé€‰ä¸¾è¿‡ç¨‹ï¼ˆFast Leader Electionï¼‰</h3>
                <div class="mermaid">
sequenceDiagram
    participant Z1 as Zookeeper 1<br/>(myid=1, zxid=100)
    participant Z2 as Zookeeper 2<br/>(myid=2, zxid=100)
    participant Z3 as Zookeeper 3<br/>(myid=3, zxid=99)
    participant Z4 as Zookeeper 4<br/>(myid=4, zxid=100)
    participant Z5 as Zookeeper 5<br/>(myid=5, zxid=100)
    
    Note over Z1,Z5: åˆå§‹çŠ¶æ€ï¼šæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯LookingçŠ¶æ€
    Note over Z1,Z5: Leaderæ•…éšœï¼Œè§¦å‘é€‰ä¸¾
    
    Z1->>Z1: æŠ•ç¥¨ç»™è‡ªå·±(1, 100, 1)
    Z2->>Z2: æŠ•ç¥¨ç»™è‡ªå·±(2, 100, 2)
    Z3->>Z3: æŠ•ç¥¨ç»™è‡ªå·±(3, 99, 3)
    Z4->>Z4: æŠ•ç¥¨ç»™è‡ªå·±(4, 100, 4)
    Z5->>Z5: æŠ•ç¥¨ç»™è‡ªå·±(5, 100, 5)
    
    Z1->>Z2: å‘é€æŠ•ç¥¨(1, 100, 1)
    Z1->>Z3: å‘é€æŠ•ç¥¨(1, 100, 1)
    Z1->>Z4: å‘é€æŠ•ç¥¨(1, 100, 1)
    Z1->>Z5: å‘é€æŠ•ç¥¨(1, 100, 1)
    
    Z2->>Z1: æ¯”è¾ƒï¼šzxidç›¸åŒ(100)ï¼Œmyidæ›´å¤§(2>1)ï¼Œæ‹’ç»
    Z3->>Z1: æ¯”è¾ƒï¼šzxidæ›´å°(99<100)ï¼Œæ‹’ç»
    Z4->>Z1: æ¯”è¾ƒï¼šzxidç›¸åŒ(100)ï¼Œmyidæ›´å¤§(4>1)ï¼Œæ‹’ç»
    Z5->>Z1: æ¯”è¾ƒï¼šzxidç›¸åŒ(100)ï¼Œmyidæ›´å¤§(5>1)ï¼Œæ‹’ç»
    
    Z4->>Z1: å‘é€æŠ•ç¥¨(4, 100, 4)
    Z4->>Z2: å‘é€æŠ•ç¥¨(4, 100, 4)
    Z4->>Z3: å‘é€æŠ•ç¥¨(4, 100, 4)
    Z4->>Z5: å‘é€æŠ•ç¥¨(4, 100, 4)
    
    Z1->>Z4: æ¥å—æŠ•ç¥¨ï¼ˆzxidç›¸åŒï¼Œmyidæ›´å¤§ï¼‰
    Z2->>Z4: æ¥å—æŠ•ç¥¨ï¼ˆzxidç›¸åŒï¼Œmyidæ›´å¤§ï¼‰
    Z3->>Z4: æ¥å—æŠ•ç¥¨ï¼ˆzxidæ›´å¤§ï¼‰
    Z5->>Z4: æ¥å—æŠ•ç¥¨ï¼ˆzxidç›¸åŒï¼Œmyidæ›´å¤§ï¼‰
    
    Note over Z4: è·å¾—å¤šæ•°ç¥¨ï¼ˆ4/5ï¼‰ï¼Œæˆä¸ºLeader
    Z4->>Z4: è½¬ä¸ºLeadingçŠ¶æ€
    
    Z4->>Z1: å‘é€NEWLEADERæ¶ˆæ¯
    Z4->>Z2: å‘é€NEWLEADERæ¶ˆæ¯
    Z4->>Z3: å‘é€NEWLEADERæ¶ˆæ¯
    Z4->>Z5: å‘é€NEWLEADERæ¶ˆæ¯
    
    Z1->>Z4: ç¡®è®¤NEWLEADER
    Z2->>Z4: ç¡®è®¤NEWLEADER
    Z3->>Z4: ç¡®è®¤NEWLEADER
    Z5->>Z4: ç¡®è®¤NEWLEADER
    
    Note over Z4: æ”¶åˆ°å¤šæ•°ç¡®è®¤ï¼Œå¼€å§‹æœåŠ¡
                </div>
            </div>

            <!-- ZABäº‹åŠ¡å¹¿æ’­ -->
            <div class="diagram-container" style="margin-top: 30px;">
                <h3>ZABäº‹åŠ¡å¹¿æ’­è¿‡ç¨‹ï¼ˆAtomic Broadcastï¼‰</h3>
                <div class="mermaid">
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant L as Leader
    participant F1 as Follower 1
    participant F2 as Follower 2
    participant F3 as Follower 3
    participant F4 as Follower 4
    
    Client->>L: æäº¤å†™è¯·æ±‚
    L->>L: ç”Ÿæˆäº‹åŠ¡ææ¡ˆ(Proposal)<br/>åˆ†é…zxid
    L->>L: å°†ææ¡ˆå†™å…¥äº‹åŠ¡æ—¥å¿—
    L->>F1: å‘é€PROPOSAL(äº‹åŠ¡ææ¡ˆ)
    L->>F2: å‘é€PROPOSAL(äº‹åŠ¡ææ¡ˆ)
    L->>F3: å‘é€PROPOSAL(äº‹åŠ¡ææ¡ˆ)
    L->>F4: å‘é€PROPOSAL(äº‹åŠ¡ææ¡ˆ)
    
    F1->>F1: éªŒè¯ææ¡ˆï¼Œå†™å…¥äº‹åŠ¡æ—¥å¿—
    F2->>F2: éªŒè¯ææ¡ˆï¼Œå†™å…¥äº‹åŠ¡æ—¥å¿—
    F3->>F3: éªŒè¯ææ¡ˆï¼Œå†™å…¥äº‹åŠ¡æ—¥å¿—
    F4->>F4: éªŒè¯ææ¡ˆï¼Œå†™å…¥äº‹åŠ¡æ—¥å¿—
    
    F1->>L: ACKç¡®è®¤
    F2->>L: ACKç¡®è®¤
    F3->>L: ACKç¡®è®¤
    F4->>L: ACKç¡®è®¤ï¼ˆå»¶è¿Ÿï¼‰
    
    Note over L: æ”¶åˆ°å¤šæ•°ACKï¼ˆ3/5ï¼‰
    L->>L: æäº¤äº‹åŠ¡(COMMIT)
    L->>L: åº”ç”¨åˆ°å†…å­˜æ•°æ®åº“
    L->>Client: è¿”å›æˆåŠŸ
    
    L->>F1: å‘é€COMMITæ¶ˆæ¯
    L->>F2: å‘é€COMMITæ¶ˆæ¯
    L->>F3: å‘é€COMMITæ¶ˆæ¯
    L->>F4: å‘é€COMMITæ¶ˆæ¯
    
    F1->>F1: æäº¤äº‹åŠ¡ï¼Œåº”ç”¨åˆ°å†…å­˜æ•°æ®åº“
    F2->>F2: æäº¤äº‹åŠ¡ï¼Œåº”ç”¨åˆ°å†…å­˜æ•°æ®åº“
    F3->>F3: æäº¤äº‹åŠ¡ï¼Œåº”ç”¨åˆ°å†…å­˜æ•°æ®åº“
    F4->>F4: æäº¤äº‹åŠ¡ï¼Œåº”ç”¨åˆ°å†…å­˜æ•°æ®åº“ï¼ˆå»¶è¿Ÿæäº¤ï¼‰
                </div>
            </div>

            <!-- ZABæ•°æ®æ¨¡å‹ -->
            <div class="diagram-container" style="margin-top: 30px;">
                <h3>Zookeeperæ•°æ®æ¨¡å‹</h3>
                <div class="mermaid">
graph TD
    Root[/] --> App1[/app1]
    Root --> App2[/app2]
    Root --> Kafka[/kafka]
    
    App1 --> Node1[/app1/node1<br/>data: value1<br/>version: 1]
    App1 --> Node2[/app1/node2<br/>data: value2<br/>version: 1]
    
    Kafka --> Brokers[/kafka/brokers<br/>ä¸´æ—¶èŠ‚ç‚¹]
    Kafka --> Controller[/kafka/controller<br/>ä¸´æ—¶èŠ‚ç‚¹]
    Kafka --> Config[/kafka/config<br/>æŒä¹…èŠ‚ç‚¹]
    
    Brokers --> B1[/kafka/brokers/1<br/>ä¸´æ—¶èŠ‚ç‚¹<br/>Broker 1ä¿¡æ¯]
    Brokers --> B2[/kafka/brokers/2<br/>ä¸´æ—¶èŠ‚ç‚¹<br/>Broker 2ä¿¡æ¯]
    Brokers --> B3[/kafka/brokers/3<br/>ä¸´æ—¶èŠ‚ç‚¹<br/>Broker 3ä¿¡æ¯]
    
    Controller --> ControllerData[controller_epoch: 1<br/>controller_id: 2<br/>timestamp: ...]
    
    style Root fill:#4caf50
    style Kafka fill:#ff9800
    style Brokers fill:#2196f3
    style Controller fill:#f44336
                </div>
            </div>

            <!-- ZABæ¢å¤æ¨¡å¼ -->
            <div class="diagram-container" style="margin-top: 30px;">
                <h3>ZABåè®®ä¸¤ç§æ¨¡å¼</h3>
                <div class="mermaid">
graph TD
    Start[ZABåè®®] --> Mode1[å´©æºƒæ¢å¤æ¨¡å¼<br/>Recovery Mode]
    Start --> Mode2[æ¶ˆæ¯å¹¿æ’­æ¨¡å¼<br/>Broadcast Mode]
    
    Mode1 --> E1[Leaderé€‰ä¸¾]
    E1 --> E2[æ•°æ®åŒæ­¥]
    E2 --> E3[å‘ç°å¤§å¤šæ•°Follower<br/>å·²åŒæ­¥å®Œæˆ]
    E3 --> Mode2
    
    Mode2 --> B1[æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚]
    B1 --> B2[ç”Ÿæˆäº‹åŠ¡ææ¡ˆ]
    B2 --> B3[å¹¿æ’­ææ¡ˆç»™Follower]
    B3 --> B4[æ”¶é›†ACKç¡®è®¤]
    B4 --> B5{æ”¶åˆ°å¤šæ•°ACK?}
    B5 -->|æ˜¯| B6[æäº¤äº‹åŠ¡]
    B5 -->|å¦| B7[ç­‰å¾…æ›´å¤šACK]
    B7 --> B5
    B6 --> B8[é€šçŸ¥Followeræäº¤]
    B8 --> B1
    
    B6 --> Check{Leaderæ•…éšœ?}
    Check -->|æ˜¯| Mode1
    Check -->|å¦| B1
    
    style Mode1 fill:#ff9800
    style Mode2 fill:#4caf50
                </div>
            </div>

            <!-- ZABä¸Raftå¯¹æ¯” -->
            <div class="diagram-container" style="margin-top: 30px;">
                <h3>ZABåè®®ä¸Raftç®—æ³•å¯¹æ¯”</h3>
                <div class="mermaid">
graph LR
    subgraph "ZABåè®®"
        Z1[äº‹åŠ¡æ—¥å¿—<br/>Transaction Log]
        Z2[ZXID<br/>äº‹åŠ¡ID]
        Z3[ä¸¤é˜¶æ®µæäº¤<br/>Proposal + Commit]
        Z4[Fast Leader Election]
    end
    
    subgraph "Raftç®—æ³•"
        R1[æ—¥å¿—æ¡ç›®<br/>Log Entries]
        R2[Term + Index<br/>ä»»æœŸ+ç´¢å¼•]
        R3[æ—¥å¿—å¤åˆ¶<br/>AppendEntries]
        R4[Leader Election]
    end
    
    Z1 -.->|ç›¸ä¼¼| R1
    Z2 -.->|ä¸åŒ| R2
    Z3 -.->|ç›¸ä¼¼| R3
    Z4 -.->|ä¸åŒ| R4
    
    style ZAB fill:#ff9800
    style Raft fill:#4caf50
                </div>
            </div>

            <div class="description" style="margin-top: 30px;">
                <h3>ZABåè®®å…³é”®ç‰¹æ€§</h3>
                <ul>
                    <li><strong>äº‹åŠ¡é¡ºåºæ€§</strong>ï¼šæ‰€æœ‰äº‹åŠ¡æŒ‰ZXIDé¡ºåºæ‰§è¡Œï¼Œä¿è¯å…¨å±€é¡ºåº</li>
                    <li><strong>åŸå­æ€§å¹¿æ’­</strong>ï¼šä½¿ç”¨ä¸¤é˜¶æ®µæäº¤ï¼ˆProposal + Commitï¼‰ä¿è¯äº‹åŠ¡åŸå­æ€§</li>
                    <li><strong>å¿«é€ŸLeaderé€‰ä¸¾</strong>ï¼šä½¿ç”¨Fast Leader Electionç®—æ³•ï¼Œå¿«é€Ÿé€‰ä¸¾æ–°Leader</li>
                    <li><strong>æ•°æ®ä¸€è‡´æ€§</strong>ï¼šé€šè¿‡å¤šæ•°æ´¾æŠ•ç¥¨å’Œäº‹åŠ¡æ—¥å¿—ä¿è¯æ•°æ®ä¸€è‡´æ€§</li>
                    <li><strong>å´©æºƒæ¢å¤</strong>ï¼šLeaderæ•…éšœæ—¶ï¼Œæ–°Leaderé€šè¿‡äº‹åŠ¡æ—¥å¿—æ¢å¤æ•°æ®</li>
                    <li><strong>è§‚å¯Ÿè€…æ¨¡å¼</strong>ï¼šæ”¯æŒObserverèŠ‚ç‚¹ï¼Œæé«˜è¯»æ€§èƒ½ä½†ä¸å‚ä¸æŠ•ç¥¨</li>
                </ul>

                <h3>ZABåè®®å…³é”®æ¦‚å¿µ</h3>
                <ul>
                    <li><strong>ZXIDï¼ˆZookeeper Transaction IDï¼‰</strong>ï¼š64ä½æ•´æ•°ï¼Œé«˜32ä½æ˜¯epochï¼Œä½32ä½æ˜¯è®¡æ•°å™¨</li>
                    <li><strong>Epoch</strong>ï¼šLeaderçš„ä»»æœŸç¼–å·ï¼Œæ¯æ¬¡é€‰ä¸¾Leaderæ—¶é€’å¢</li>
                    <li><strong>äº‹åŠ¡æ—¥å¿—</strong>ï¼šæ‰€æœ‰å†™æ“ä½œéƒ½è®°å½•åˆ°äº‹åŠ¡æ—¥å¿—ï¼Œç”¨äºæ¢å¤å’Œå¤åˆ¶</li>
                    <li><strong>å¿«ç…§ï¼ˆSnapshotï¼‰</strong>ï¼šå®šæœŸç”Ÿæˆæ•°æ®å¿«ç…§ï¼Œç”¨äºå¿«é€Ÿæ¢å¤</li>
                    <li><strong>ä¼šè¯ï¼ˆSessionï¼‰</strong>ï¼šå®¢æˆ·ç«¯ä¸ZookeeperæœåŠ¡å™¨çš„è¿æ¥ä¼šè¯ï¼Œæœ‰è¶…æ—¶æœºåˆ¶</li>
                </ul>

                <h3>Zookeeperåœ¨Kafkaä¸­çš„åº”ç”¨</h3>
                <ul>
                    <li><strong>Brokeræ³¨å†Œ</strong>ï¼šBrokerå¯åŠ¨æ—¶åœ¨Zookeeperä¸­æ³¨å†Œä¸´æ—¶èŠ‚ç‚¹</li>
                    <li><strong>Controlleré€‰ä¸¾</strong>ï¼šé€šè¿‡ç«äº‰åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹é€‰ä¸¾Controller</li>
                    <li><strong>Topicé…ç½®</strong>ï¼šTopicçš„é…ç½®ä¿¡æ¯å­˜å‚¨åœ¨Zookeeperä¸­</li>
                    <li><strong>åˆ†åŒºåˆ†é…</strong>ï¼šPartitionçš„Leaderå’ŒISRä¿¡æ¯å­˜å‚¨åœ¨Zookeeperä¸­</li>
                    <li><strong>Consumer Group</strong>ï¼šConsumer Groupçš„Offsetå’Œæˆå‘˜ä¿¡æ¯å­˜å‚¨åœ¨Zookeeperä¸­ï¼ˆæ—§ç‰ˆæœ¬ï¼‰</li>
                </ul>

                <h3>Zookeeperä¸KRaftçš„å¯¹æ¯”</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <tr style="background: #f5f5f5;">
                        <th style="border: 1px solid #ddd; padding: 8px;">ç‰¹æ€§</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Zookeeper</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">KRaft</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">ä¾èµ–</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">éœ€è¦ç‹¬ç«‹çš„Zookeeperé›†ç¾¤</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">æ— éœ€å¤–éƒ¨ä¾èµ–ï¼Œå†…ç½®Raft</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">æ•…éšœæ¢å¤</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">ç§’çº§åˆ°åˆ†é’Ÿçº§</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">ç§’çº§</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">æ‰©å±•æ€§</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">å—Zookeeperé™åˆ¶</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">æ”¯æŒæ›´å¤§è§„æ¨¡é›†ç¾¤</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">æ€§èƒ½</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">å…ƒæ•°æ®æ“ä½œæœ‰ç½‘ç»œå»¶è¿Ÿ</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">æ›´ä½çš„å»¶è¿Ÿï¼Œæ›´é«˜çš„ååé‡</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">éƒ¨ç½²</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">éœ€è¦å•ç‹¬éƒ¨ç½²å’Œç»´æŠ¤</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">ç®€åŒ–éƒ¨ç½²ï¼Œç»Ÿä¸€ç®¡ç†</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- å…³é”®æ¦‚å¿µè¯´æ˜ -->
        <div class="diagram-section">
            <h2>ğŸ“š å…³é”®æ¦‚å¿µè¯´æ˜</h2>
            <div class="description">
                <h3>Producer (ç”Ÿäº§è€…)</h3>
                <ul>
                    <li>è´Ÿè´£å‘Kafkaå‘é€æ¶ˆæ¯</li>
                    <li>æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥å‘é€</li>
                    <li>å¯é…ç½®ç¡®è®¤æœºåˆ¶(<code>acks: 0/1/all</code>)</li>
                    <li>æ”¯æŒæ¶ˆæ¯åˆ†åŒºç­–ç•¥</li>
                </ul>

                <h3>Consumer (æ¶ˆè´¹è€…)</h3>
                <ul>
                    <li>ä»Kafkaæ‹‰å–å¹¶å¤„ç†æ¶ˆæ¯</li>
                    <li>å±äºConsumer Groupï¼Œå®ç°è´Ÿè½½å‡è¡¡</li>
                    <li>ç»´æŠ¤æ¶ˆè´¹åç§»é‡(Offset)</li>
                    <li>æ”¯æŒè‡ªåŠ¨å’Œæ‰‹åŠ¨æäº¤Offset</li>
                </ul>

                <h3>Broker (ä»£ç†æœåŠ¡å™¨)</h3>
                <ul>
                    <li>Kafkaé›†ç¾¤ä¸­çš„èŠ‚ç‚¹</li>
                    <li>å­˜å‚¨æ¶ˆæ¯åˆ°æœ¬åœ°ç£ç›˜</li>
                    <li>å¤„ç†Producerå’ŒConsumerçš„è¯·æ±‚</li>
                    <li>è´Ÿè´£å‰¯æœ¬å¤åˆ¶å’ŒLeaderé€‰ä¸¾</li>
                </ul>

                <h3>Topic (ä¸»é¢˜)</h3>
                <ul>
                    <li>æ¶ˆæ¯çš„é€»è¾‘åˆ†ç±»</li>
                    <li>å¯ä»¥åŒ…å«å¤šä¸ªPartition</li>
                    <li>æ”¯æŒå¤šå‰¯æœ¬ä»¥æé«˜å¯ç”¨æ€§</li>
                </ul>

                <h3>Partition (åˆ†åŒº)</h3>
                <ul>
                    <li>Topicçš„ç‰©ç†åˆ†å‰²</li>
                    <li>æ¯ä¸ªPartitionæœ‰åºå­˜å‚¨</li>
                    <li>æ”¯æŒæ°´å¹³æ‰©å±•å’Œå¹¶è¡Œå¤„ç†</li>
                </ul>

                <h3>Consumer Group (æ¶ˆè´¹ç»„)</h3>
                <ul>
                    <li>å¤šä¸ªConsumerçš„é›†åˆ</li>
                    <li>å®ç°æ¶ˆæ¯çš„è´Ÿè½½å‡è¡¡</li>
                    <li>æ¯ä¸ªPartitionåªèƒ½è¢«Groupä¸­çš„ä¸€ä¸ªConsumeræ¶ˆè´¹</li>
                </ul>
            </div>
        </div>

        <!-- é…ç½®è¦ç‚¹ -->
        <div class="diagram-section">
            <h2>âš™ï¸ é…ç½®è¦ç‚¹</h2>
            <div class="description">
                <h3>Produceré…ç½®</h3>
                <ul>
                    <li><code>bootstrap.servers</code>: Kafkaé›†ç¾¤åœ°å€</li>
                    <li><code>acks</code>: æ¶ˆæ¯ç¡®è®¤æœºåˆ¶</li>
                    <li><code>retries</code>: é‡è¯•æ¬¡æ•°</li>
                    <li><code>batch.size</code>: æ‰¹æ¬¡å¤§å°</li>
                    <li><code>linger.ms</code>: ç­‰å¾…æ—¶é—´</li>
                </ul>

                <h3>Consumeré…ç½®</h3>
                <ul>
                    <li><code>group.id</code>: æ¶ˆè´¹ç»„ID</li>
                    <li><code>auto.offset.reset</code>: Offseté‡ç½®ç­–ç•¥</li>
                    <li><code>enable.auto.commit</code>: æ˜¯å¦è‡ªåŠ¨æäº¤Offset</li>
                    <li><code>fetch.min.bytes</code>: æœ€å°æ‹‰å–å­—èŠ‚æ•°</li>
                    <li><code>max.partition.fetch.bytes</code>: å•åˆ†åŒºæœ€å¤§æ‹‰å–å­—èŠ‚æ•°</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ– Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35
            }
        });

        // å¹³æ»‘æ»šåŠ¨
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    </script>
</body>
</html>

