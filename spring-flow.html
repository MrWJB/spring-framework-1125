<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring 5 æµç¨‹å›¾å¯è§†åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #536976 0%, #292E49 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 14px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.35);
            padding: 44px;
        }

        h1 {
            text-align: center;
            font-size: 2.6em;
            color: #1a237e;
            margin-bottom: 12px;
        }

        .subtitle {
            text-align: center;
            color: #455a64;
            margin-bottom: 42px;
            font-size: 1.1em;
        }

        .toc {
            background: #f5f7fa;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 42px;
        }

        .toc h3 {
            color: #1a237e;
            margin-bottom: 16px;
        }

        .toc ul {
            list-style: none;
            columns: 2;
            column-gap: 30px;
        }

        .toc li {
            margin: 8px 0;
        }

        .toc a {
            color: #3949ab;
            text-decoration: none;
            transition: color 0.3s;
        }

        .toc a:hover {
            color: #5c6bc0;
            text-decoration: underline;
        }

        .diagram-section {
            margin-bottom: 56px;
            padding: 32px;
            background: #fafafa;
            border-radius: 12px;
            border-left: 5px solid #3949ab;
        }

        .diagram-section h2 {
            color: #1a237e;
            font-size: 1.9em;
            margin-bottom: 16px;
        }

        .diagram-container {
            background: #ffffff;
            padding: 24px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow-x: auto;
        }

        .diagram-container + .diagram-container {
            margin-top: 24px;
        }

        .mermaid {
            min-height: 320px;
        }

        .description {
            margin-top: 20px;
            background: #ffffff;
            border-radius: 10px;
            padding: 20px;
            color: #455a64;
            line-height: 1.65;
            box-shadow: inset 0 0 0 1px rgba(57, 73, 171, 0.08);
        }

        .description h3 {
            color: #3949ab;
            margin-bottom: 12px;
        }

        .description ul {
            margin: 12px 0 12px 22px;
        }

        .description li {
            margin-bottom: 8px;
        }

        code {
            background: #eceff1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
            font-size: 0.95em;
            color: #d81b60;
        }

        @media print {
            body {
                background: #ffffff;
            }
            .container {
                box-shadow: none;
            }
            .toc ul {
                columns: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ± Spring 5 æ ¸å¿ƒæµç¨‹å›¾å¯è§†åŒ–</h1>
        <p class="subtitle">è¦†ç›– Spring Framework 5.x æ ¸å¿ƒå®¹å™¨ã€MVCã€WebFluxã€AOPã€äº‹åŠ¡ã€Boot ç­‰å…³é”®æœºåˆ¶çš„æµç¨‹è§£æ</p>

        <div class="toc">
            <h3>ğŸ“‘ ç›®å½•å¯¼èˆª</h3>
            <ul>
                <li><a href="#spring-core">1. Spring æ ¸å¿ƒå®¹å™¨æ¦‚è§ˆ</a></li>
                <li><a href="#bean-loading">2. Bean å®šä¹‰åŠ è½½æµç¨‹</a></li>
                <li><a href="#bean-lifecycle">3. Bean ç”Ÿå‘½å‘¨æœŸå®Œæ•´æµç¨‹</a></li>
                <li><a href="#context-refresh">4. ApplicationContext åˆ·æ–°æµç¨‹</a></li>
                <li><a href="#dependency-injection">5. ä¾èµ–æ³¨å…¥è§£æä¸è£…é…æµç¨‹</a></li>
                <li><a href="#beanpostprocessor">6. BeanPostProcessor è°ƒç”¨é“¾</a></li>
                <li><a href="#spring-aop">7. Spring AOP ä»£ç†åˆ›å»ºæµç¨‹</a></li>
                <li><a href="#spring-transaction">8. å£°æ˜å¼äº‹åŠ¡ç®¡ç†æµç¨‹</a></li>
                <li><a href="#spring-mvc">9. Spring MVC è¯·æ±‚å¤„ç†æµç¨‹</a></li>
                <li><a href="#spring-webflux">10. Spring WebFlux å“åº”å¼è¯·æ±‚æµç¨‹</a></li>
                <li><a href="#spring-boot">11. Spring Boot å¯åŠ¨æµç¨‹</a></li>
                <li><a href="#spring-autoconfig">12. è‡ªåŠ¨é…ç½®ç­›é€‰ä¸ç”Ÿæ•ˆæµç¨‹</a></li>
                <li><a href="#spring-events">13. åº”ç”¨äº‹ä»¶å‘å¸ƒä¸ç›‘å¬æœºåˆ¶</a></li>
                <li><a href="#spring-scheduling">14. è°ƒåº¦ä¸å¼‚æ­¥æ‰§è¡Œæµç¨‹</a></li>
                <li><a href="#spring-glossary">15. æ ¸å¿ƒæ¦‚å¿µé€Ÿè§ˆ</a></li>
            </ul>
        </div>

        <!-- Section 1 -->
        <div class="diagram-section" id="spring-core">
            <h2>1. Spring æ ¸å¿ƒå®¹å™¨æ¦‚è§ˆ</h2>
            <div class="diagram-container">
                <div class="mermaid">
graph TD
    A[ApplicationContext] --> B[BeanFactory<br/>æ ¸å¿ƒ Bean ç®¡ç†]
    A --> C[Environment<br/>é…ç½®ä¸ Profiles]
    A --> D[ResourceLoader<br/>èµ„æºåŠ è½½]
    A --> E[ApplicationEventMulticaster<br/>äº‹ä»¶å¹¿æ’­]
    A --> F[LifecycleProcessor<br/>ç”Ÿå‘½å‘¨æœŸæ§åˆ¶]

    B --> G[BeanDefinitionRegistry<br/>Bean å®šä¹‰æ³¨å†Œè¡¨]
    G --> H[BeanDefinition<br/>Bean å…ƒæ•°æ®]
    B --> I[SingletonObjects<br/>ä¸€çº§ç¼“å­˜]
    B --> J[Prototype Beans<br/>åŸå‹å®ä¾‹]

    C --> K[PropertySources]
    D --> L[Resource]

    style A fill:#4caf50,color:#fff
    style B fill:#ffcc80
    style C fill:#90caf9
    style D fill:#90caf9
    style E fill:#f48fb1
    style F fill:#a5d6a7
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <ul>
                    <li>ApplicationContext èšåˆ BeanFactoryã€Environmentã€äº‹ä»¶å¹¿æ’­ã€èµ„æºåŠ è½½ç­‰æ¨¡å—èƒ½åŠ›ã€‚</li>
                    <li>BeanDefinitionRegistry æŒæœ‰ Bean å…ƒæ•°æ®ï¼Œé©±åŠ¨å®ä¾‹åŒ–åŠç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚</li>
                    <li>å•ä¾‹ Bean ç¼“å­˜åœ¨ä¸€çº§ç¼“å­˜ä¸­ï¼ŒåŸå‹ Bean æ¯æ¬¡è¯·æ±‚éƒ½ä¼šé‡æ–°åˆ›å»ºã€‚</li>
                </ul>
            </div>
        </div>

        <!-- Section 2 -->
        <div class="diagram-section" id="bean-loading">
            <h2>2. Bean å®šä¹‰åŠ è½½æµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
sequenceDiagram
    participant App as åº”ç”¨å¯åŠ¨
    participant AC as AnnotationConfigApplicationContext
    participant Reader as AnnotatedBeanDefinitionReader
    participant Scanner as ClassPathScanner
    participant Registry as BeanDefinitionRegistry

    App->>AC: new AnnotationConfigApplicationContext(...)
    AC->>Reader: register(configClasses)
    Reader->>Registry: æ³¨å†Œé…ç½®ç±» BeanDefinition
    Reader->>Scanner: æ‰«æ @Component / @Bean
    Scanner->>Registry: æ³¨å†Œå€™é€‰ BeanDefinition
    Registry-->>AC: Bean å®šä¹‰æ³¨å†Œå®Œæˆ
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <ul>
                    <li>æ³¨è§£é©±åŠ¨å®¹å™¨ç”± AnnotatedBeanDefinitionReader ä¸ ClassPathScanner ååŒæ³¨å†Œ Bean å®šä¹‰ã€‚</li>
                    <li>XML é…ç½®åœºæ™¯ç”± XmlBeanDefinitionReader ç­‰å®ç°å®ŒæˆåŠ è½½ï¼ŒåŸç†ä¸€è‡´ã€‚</li>
                </ul>
            </div>
        </div>

        <!-- Section 3 -->
        <div class="diagram-section" id="bean-lifecycle">
            <h2>3. Bean ç”Ÿå‘½å‘¨æœŸå®Œæ•´æµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
flowchart TD
    Start[å‡†å¤‡å®ä¾‹åŒ– Bean] --> Instantiate[å®ä¾‹åŒ–<br/>Constructor æˆ– FactoryMethod]
    Instantiate --> Populate[å±æ€§å¡«å……<br/>ä¾èµ–æ³¨å…¥]
    Populate --> Aware[å›è°ƒ *Aware æ¥å£]
    Aware --> BeforeInit[BeanPostProcessor.postProcessBeforeInitialization]
    BeforeInit --> InitMethod[æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•<br/>InitializingBean.afterPropertiesSet / @PostConstruct / init-method]
    InitMethod --> AfterInit[BeanPostProcessor.postProcessAfterInitialization]
    AfterInit --> Ready[Bean å‡†å¤‡å°±ç»ª]
    Ready --> Destroy[å®¹å™¨å…³é—­è§¦å‘é”€æ¯]
    Destroy --> DestroyCallbacks[DisposableBean.destroy / @PreDestroy / destroy-method]

    style Start fill:#e0f7fa
    style Ready fill:#a5d6a7
    style Destroy fill:#ef9a9a
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <ul>
                    <li>BeanPostProcessor åœ¨åˆå§‹åŒ–å‰åä»‹å…¥ï¼Œæ˜¯ AOPã€@Autowired ç­‰åŠŸèƒ½çš„åŸºç¡€ã€‚</li>
                    <li>é”€æ¯é˜¶æ®µä»…å¯¹é prototype Bean ç”Ÿæ•ˆï¼ŒåŸå‹ Bean éœ€è°ƒç”¨æ–¹æ‰‹åŠ¨é”€æ¯ã€‚</li>
                </ul>
            </div>
            <div class="description">
                <h3>ä»£ç ç¤ºä¾‹ï¼šBean ç”Ÿå‘½å‘¨æœŸä¸ BeanPostProcessor</h3>
                <p>1) Bean çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼š@PostConstruct / @PreDestroy ä¸ InitializingBean / DisposableBean</p>
                <pre><code class="language-java">import jakarta.annotation.PostConstruct;
import jakarta.annotation.PreDestroy;
import org.springframework.beans.factory.DisposableBean;
import org.springframework.beans.factory.InitializingBean;
import org.springframework.stereotype.Component;

@Component
public class PaymentClient implements InitializingBean, DisposableBean {
    public PaymentClient() {
        System.out.println("1) æ„é€ å‡½æ•°");
    }

    @PostConstruct // ä¾èµ–æ³¨å…¥å®Œæˆåè°ƒç”¨
    public void init() {
        System.out.println("2) @PostConstruct åˆå§‹åŒ–");
    }

    @Override
    public void afterPropertiesSet() {
        System.out.println("3) InitializingBean.afterPropertiesSet");
    }

    @PreDestroy
    public void preDestroy() {
        System.out.println("5) @PreDestroy æ¸…ç†èµ„æº");
    }

    @Override
    public void destroy() {
        System.out.println("6) DisposableBean.destroy");
    }
}</code></pre>

                <p>2) è‡ªå®šä¹‰ BeanPostProcessorï¼šåœ¨åˆå§‹åŒ–å‰åç»‡å…¥æ¨ªåˆ‡é€»è¾‘</p>
                <pre><code class="language-java">import org.springframework.beans.BeansException;
import org.springframework.beans.factory.config.BeanPostProcessor;
import org.springframework.stereotype.Component;

@Component
public class AuditBeanPostProcessor implements BeanPostProcessor {
    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
        if (bean instanceof PaymentClient) {
            System.out.println("4) BeforeInitialization: " + beanName);
        }
        return bean;
    }

    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
        if (bean instanceof PaymentClient) {
            System.out.println("4.5) AfterInitialization: " + beanName);
        }
        return bean;
    }
}</code></pre>
            </div>
        </div>

        <!-- Section 4 -->
        <div class="diagram-section" id="context-refresh">
            <h2>4. ApplicationContext åˆ·æ–°æµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
sequenceDiagram
    participant C as ApplicationContext
    C->>C: refresh()
    C->>C: prepareRefresh
    C->>C: obtainFreshBeanFactory
    C->>C: prepareBeanFactory
    C->>C: invokeBeanFactoryPostProcessors
    C->>C: registerBeanPostProcessors
    C->>C: initMessageSource
    C->>C: initApplicationEventMulticaster
    C->>C: onRefresh
    C->>C: registerListeners
    C->>C: finishBeanFactoryInitialization
    C->>C: finishRefresh
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <ul>
                    <li>BeanFactoryPostProcessor åœ¨ Bean å®ä¾‹åŒ–å‰è¿è¡Œï¼Œå¯æ‰¹é‡ä¿®æ”¹ BeanDefinitionã€‚</li>
                    <li>BeanPostProcessor æ³¨å†Œå®Œæˆåæ‰è¿›è¡Œå•ä¾‹ Bean åˆ›å»ºï¼Œç¡®ä¿æ‰©å±•ç‚¹èƒ½å‚ä¸ç”Ÿå‘½å‘¨æœŸã€‚</li>
                </ul>
            </div>
            <div class="description">
                <h3>ä»£ç ç¤ºä¾‹ï¼šåœ¨åˆ·æ–°é˜¶æ®µè°ƒä¼˜ Bean å®šä¹‰</h3>
                <pre><code class="language-java">import org.springframework.beans.BeansException;
import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.beans.factory.config.BeanFactoryPostProcessor;
import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;
import org.springframework.context.annotation.Configuration;

@Configuration
public class AppBootstrapTuning implements BeanFactoryPostProcessor {
    @Override
    public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException {
        if (beanFactory.containsBeanDefinition("taskExecutor")) {
            BeanDefinition def = beanFactory.getBeanDefinition("taskExecutor");
            // åœ¨å®¹å™¨åˆ·æ–°é˜¶æ®µè¦†ç›–å±æ€§
            def.getPropertyValues().add("corePoolSize", 8);
            def.getPropertyValues().add("maxPoolSize", 32);
        }
    }
}</code></pre>
            </div>
        </div>

        <!-- Section 5 -->
        <div class="diagram-section" id="dependency-injection">
            <h2>5. ä¾èµ–æ³¨å…¥è§£æä¸è£…é…æµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
sequenceDiagram
    participant BF as AutowireCapableBeanFactory
    participant BD as BeanDefinition
    participant DD as DependencyDescriptor
    participant Resolver as DependencyResolver
    participant Candidates as å€™é€‰ Beans

    BF->>BD: éå†éœ€è¦æ³¨å…¥çš„å±æ€§/æ„é€ å‚æ•°
    BD->>DD: åˆ›å»º DependencyDescriptor
    DD->>Resolver: è¯·æ±‚ä¾èµ–è§£æ
    Resolver->>Candidates: æŸ¥æ‰¾ @Qualifier / @Primary / ç±»å‹åŒ¹é…
    Candidates-->>Resolver: è¿”å›åŒ¹é…ç»“æœ
    Resolver->>BF: é€‰å®š Bean å®ä¾‹ / å€¼
    BF->>BD: æ³¨å…¥å±æ€§
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <ul>
                    <li>ä¾èµ–è§£æä¼˜å…ˆçº§ï¼š@Lookup â†’ @Autowired â†’ @Qualifier â†’ @Primary â†’ Bean åç§° â†’ æŒ‰ç±»å‹åŒ¹é…ã€‚</li>
                    <li>å¾ªç¯ä¾èµ–é€šè¿‡ä¸‰çº§ç¼“å­˜ï¼ˆsingletonFactoriesï¼‰æš´éœ²æå‰å¼•ç”¨è§£å†³ã€‚</li>
                </ul>
            </div>
            <div class="description">
                <h3>ä»£ç ç¤ºä¾‹ï¼šæ„é€ å™¨æ³¨å…¥ä¸ @Qualifier/@Primary</h3>
                <pre><code class="language-java">public interface PaymentGateway {
    void charge(long amount);
}</code></pre>
                <pre><code class="language-java">import org.springframework.context.annotation.Primary;
import org.springframework.stereotype.Component;

@Component
@Primary // é»˜è®¤ä¼˜å…ˆè¢«æ³¨å…¥
public class StripeGateway implements PaymentGateway {
    public void charge(long amount) { /* è°ƒç”¨ Stripe API */ }
}</code></pre>
                <pre><code class="language-java">import org.springframework.stereotype.Component;

@Component("paypalGateway")
public class PaypalGateway implements PaymentGateway {
    public void charge(long amount) { /* è°ƒç”¨ PayPal API */ }
}</code></pre>
                <pre><code class="language-java">import org.springframework.stereotype.Service;
import org.springframework.beans.factory.annotation.Qualifier;

@Service
public class BillingService {
    private final PaymentGateway gateway;

    public BillingService(@Qualifier("paypalGateway") PaymentGateway gateway) {
        this.gateway = gateway;
    }

    public void pay(long amount) {
        gateway.charge(amount);
    }
}</code></pre>
            </div>
        </div>

        <!-- Section 6 -->
        <div class="diagram-section" id="beanpostprocessor">
            <h2>6. BeanPostProcessor è°ƒç”¨é“¾</h2>
            <div class="diagram-container">
                <div class="mermaid">
graph TD
    A[Bean åˆ›å»ºæµç¨‹] --> B1[InstantiationAwareBeanPostProcessor<br/>postProcessBeforeInstantiation]
    B1 --> B2[å®ä¾‹åŒ– Bean]
    B2 --> B3[InstantiationAwareBeanPostProcessor<br/>postProcessAfterInstantiation]
    B3 --> B4[SmartInstantiationAwareBeanPostProcessor<br/>getEarlyBeanReference]
    B4 --> B5[å±æ€§å¡«å……]
    B5 --> B6[InstantiationAwareBeanPostProcessor<br/>postProcessProperties]
    B6 --> B7[BeanPostProcessor<br/>postProcessBeforeInitialization]
    B7 --> B8[Bean åˆå§‹åŒ–æ–¹æ³•]
    B8 --> B9[BeanPostProcessor<br/>postProcessAfterInitialization]
    B9 --> Ready[Bean å¯ç”¨ / è¿›å…¥ä¸€çº§ç¼“å­˜]

    style Ready fill:#aed581
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <ul>
                    <li>SmartInstantiationAwareBeanPostProcessor#getEarlyBeanReference ç”¨äºæå‰æš´éœ²ä»£ç† Beanã€‚</li>
                    <li>é…ç½®ç»‘å®šã€æ•°æ®æ ¡éªŒã€AOP ç­‰æ‰©å±•å‡ä¾èµ–è¯¥é“¾è·¯ä¸­çš„ä¸åŒå›è°ƒã€‚</li>
                </ul>
            </div>
        </div>

        <!-- Section 7 -->
        <div class="diagram-section" id="spring-aop">
            <h2>7. Spring AOP ä»£ç†åˆ›å»ºæµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
sequenceDiagram
    participant Container as ApplicationContext
    participant AutoProxyCreator as AnnotationAwareAspectJAutoProxyCreator
    participant Advisor as Advisor/Advice
    participant ProxyFactory as ProxyFactory
    participant Bean as ç›®æ ‡ Bean
    participant Client as è°ƒç”¨æ–¹

    Container->>AutoProxyCreator: åˆ›å»º Bean å‰å›è°ƒ
    AutoProxyCreator->>Advisor: æ£€ç´¢åŒ¹é…çš„åˆ‡é¢/é€šçŸ¥
    Advisor-->>AutoProxyCreator: è¿”å›å€™é€‰ Advisor åˆ—è¡¨
    AutoProxyCreator->>ProxyFactory: æ„å»ºä»£ç†æ‰€éœ€ä¿¡æ¯
    ProxyFactory->>Bean: åˆ›å»ºä»£ç†(åŸºäº JDK åŠ¨æ€ä»£ç†æˆ– CGLIB)
    ProxyFactory-->>Container: è¿”å›ä»£ç† Bean
    Container-->>Client: æš´éœ²ä»£ç†å¯¹è±¡
    Client->>ProxyFactory: è°ƒç”¨æ–¹æ³•
    ProxyFactory->>Advisor: æ‰§è¡Œæ‹¦æˆªé“¾ (MethodInterceptor)
    Advisor->>Bean: è°ƒç”¨çœŸå®æ–¹æ³•
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <ul>
                    <li>å­˜åœ¨æ¥å£æ—¶ä¼˜å…ˆä½¿ç”¨ JDK Proxyï¼Œæ— æ¥å£æ—¶å›é€€åˆ° CGLIBã€‚</li>
                    <li>MethodInterceptor ç»„æˆçš„è´£ä»»é“¾è´Ÿè´£æ‰§è¡Œå‰ç½®ã€åç½®ã€ç¯ç»•ç­‰é€šçŸ¥ã€‚</li>
                </ul>
            </div>
            <div class="description">
                <h3>ä»£ç ç¤ºä¾‹ï¼šå£°æ˜å¼ AOPï¼ˆè®°å½•æ¥å£è°ƒç”¨æ—¶é•¿ï¼‰</h3>
                <pre><code class="language-java">import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.springframework.stereotype.Component;

@Aspect
@Component
@Slf4j
public class TimingAspect {
    @Around("execution(* com.example.service..*Service.*(..))")
    public Object time(ProceedingJoinPoint pjp) throws Throwable {
        long start = System.currentTimeMillis();
        try {
            return pjp.proceed();
        } finally {
            long cost = System.currentTimeMillis() - start;
            log.info("Method {} took {} ms", pjp.getSignature(), cost);
        }
    }
}</code></pre>
            </div>
        </div>

        <!-- Section 8 -->
        <div class="diagram-section" id="spring-transaction">
            <h2>8. å£°æ˜å¼äº‹åŠ¡ç®¡ç†æµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
flowchart TD
    Start[@Transactional æ–¹æ³•è°ƒç”¨] --> Interceptor[TransactionInterceptor]
    Interceptor --> AttrSource[TransactionAttributeSource<br/>è§£æäº‹åŠ¡å±æ€§]
    AttrSource --> Manager[PlatformTransactionManager<br/>å¦‚ DataSourceTransactionManager]
    Manager --> Begin[è·å–/åˆ›å»ºç‰©ç†äº‹åŠ¡]
    Begin --> Invoke[æ‰§è¡Œç›®æ ‡æ–¹æ³•]
    Invoke --> Check{æ˜¯å¦æŠ›å‡ºå¼‚å¸¸?}
    Check -->|å¦| Commit[æäº¤äº‹åŠ¡]
    Check -->|æ˜¯| Rollback[å›æ»šäº‹åŠ¡]
    Commit --> Cleanup[æ¸…ç†çº¿ç¨‹ç»‘å®šèµ„æº]
    Rollback --> Cleanup
    Cleanup --> End[è¿”å›è°ƒç”¨æ–¹]

    style Start fill:#4caf50,color:#fff
    style Commit fill:#81c784
    style Rollback fill:#e57373
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <ul>
                    <li>äº‹åŠ¡å±æ€§åŒ…å«ä¼ æ’­è¡Œä¸ºã€éš”ç¦»çº§åˆ«ã€è¶…æ—¶æ—¶é—´ä¸å›æ»šè§„åˆ™ã€‚</li>
                    <li>TransactionSynchronizationManager è´Ÿè´£å°†èµ„æºç»‘å®šåˆ°å½“å‰çº¿ç¨‹ï¼Œä¿è¯äº‹åŠ¡ä¸Šä¸‹æ–‡ã€‚</li>
                </ul>
            </div>
            <div class="description">
                <h3>ä»£ç ç¤ºä¾‹ï¼š@Transactional ä¸äº‹åŠ¡ç®¡ç†å™¨</h3>
                <pre><code class="language-java">import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.annotation.EnableTransactionManagement;
import javax.sql.DataSource;

@Configuration
@EnableTransactionManagement
public class TxConfig {
    @Bean
    public PlatformTransactionManager txManager(DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}</code></pre>
                <pre><code class="language-java">import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
public class OrderService {
    private final PaymentGateway gateway;
    public OrderService(PaymentGateway gateway) { this.gateway = gateway; }

    @Transactional
    public void placeOrder(Order order) {
        gateway.charge(order.total());
        // æŒä¹…åŒ–è®¢å•ç­‰æ“ä½œ
    }
}</code></pre>
            </div>
        </div>

        <!-- Section 9 -->
        <div class="diagram-section" id="spring-mvc">
            <h2>9. Spring MVC è¯·æ±‚å¤„ç†æµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
sequenceDiagram
    participant Client as æµè§ˆå™¨/å®¢æˆ·ç«¯
    participant DS as DispatcherServlet
    participant HM as HandlerMapping
    participant HA as HandlerAdapter
    participant Controller as Controller/Handler
    participant ViewResolver as ViewResolver
    participant View as View

    Client->>DS: HTTP è¯·æ±‚
    DS->>HM: æŸ¥æ‰¾ HandlerMapping
    HM-->>DS: è¿”å› HandlerExecutionChain
    DS->>HA: è·å–ç›¸åº” HandlerAdapter
    HA->>Controller: è°ƒç”¨æ§åˆ¶å™¨æ–¹æ³•
    Controller-->>HA: è¿”å› ModelAndView / ResponseEntity
    HA-->>DS: ä¼ é€’å¤„ç†ç»“æœ
    DS->>ViewResolver: è§£æè§†å›¾ (è‹¥éç›´æ¥å†™å“åº”)
    ViewResolver-->>DS: è¿”å› View
    DS->>View: æ¸²æŸ“æ¨¡å‹
    View-->>Client: è¾“å‡ºå“åº”
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <ul>
                    <li>HandlerInterceptor å¯åœ¨æ‰§è¡Œé“¾ä¸­æ‹¦æˆªï¼Œå®ç°è®¤è¯ã€æ—¥å¿—ç­‰æ¨ªåˆ‡é€»è¾‘ã€‚</li>
                    <li>MessageConverter å¯¹ @RequestBody/@ResponseBody è¿›è¡Œåºåˆ—åŒ–ä¸ååºåˆ—åŒ–ã€‚</li>
                </ul>
            </div>
            <div class="description">
                <h3>ä»£ç ç¤ºä¾‹ï¼šController + æ‹¦æˆªå™¨æ³¨å†Œ</h3>
                <pre><code class="language-java">import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class OrderController {
    private final OrderService service;
    public OrderService(OrderService service) { this.service = service; }

    @GetMapping("/orders/{id}")
    public OrderView get(@PathVariable Long id) {
        return service.findView(id);
    }
}</code></pre>
                <pre><code class="language-java">import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.HandlerInterceptor;

@Component
public class AuthInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest req, HttpServletResponse res, Object handler) throws Exception {
        String token = req.getHeader("X-Auth");
        if (token == null || token.isBlank()) {
            res.setStatus(401);
            return false;
        }
        return true;
    }
}</code></pre>
                <pre><code class="language-java">import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Autowired
    private AuthInterceptor authInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(authInterceptor).addPathPatterns("/**");
    }
}</code></pre>
            </div>
        </div>

        <!-- Section 10 -->
        <div class="diagram-section" id="spring-webflux">
            <h2>10. Spring WebFlux å“åº”å¼è¯·æ±‚æµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
sequenceDiagram
    participant Client as Reactive Client
    participant WebHandler as DispatcherHandler
    participant Router as RouterFunction
    participant Handler as HandlerFunction
    participant Publisher as Mono/Flux
    participant Server as Netty/Undertow

    Client->>Server: HTTP è¯·æ±‚
    Server->>WebHandler: äº¤ç»™ DispatcherHandler
    WebHandler->>Router: åŒ¹é…è·¯ç”±
    Router-->>WebHandler: è¿”å› HandlerFunction
    WebHandler->>Handler: è°ƒç”¨å¤„ç†å‡½æ•°
    Handler-->>WebHandler: è¿”å› Mono/Flux
    WebHandler->>Publisher: è®¢é˜…æ•°æ®æµ
    Publisher-->>Server: æ¨é€å“åº”æ•°æ®
    Server-->>Client: å“åº”æµå¼è¿”å›
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <ul>
                    <li>åŸºäº Reactor çš„éé˜»å¡æ‰§è¡Œæ¨¡å‹ï¼Œé»˜è®¤ä½¿ç”¨ Netty è¿è¡Œæ—¶ã€‚</li>
                    <li>WebFilter / HandlerFilterFunction å¯åœ¨å“åº”å¼é“¾è·¯ä¸­å¤„ç†è·¨åŸŸã€é‰´æƒç­‰é€»è¾‘ã€‚</li>
                </ul>
            </div>
        </div>

        <!-- Section 11 -->
        <div class="diagram-section" id="spring-boot">
            <h2>11. Spring Boot å¯åŠ¨æµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
flowchart TD
    Start[SpringApplication.run] --> CreateApp[æ„é€  SpringApplication]
    CreateApp --> Infer[æ¨æ–­ WebApplicationType]
    Infer --> PrepareEnv[ApplicationContextInitializer<br/>Environment å¤„ç†]
    PrepareEnv --> Listeners[SpringApplicationRunListeners<br/>å‘å¸ƒäº‹ä»¶]
    Listeners --> Context[åˆ›å»º ApplicationContext]
    Context --> LoadSources[åŠ è½½ä¸»é…ç½®ç±» / SpringBootApplication]
    LoadSources --> Refresh[è°ƒç”¨ context.refresh]
    Refresh --> CallRunners[ApplicationRunner / CommandLineRunner]
    CallRunners --> Ready[åº”ç”¨å¯åŠ¨å®Œæˆ]

    style Start fill:#1976d2,color:#fff
    style Ready fill:#81c784
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <ul>
                    <li>SpringFactoriesLoader ç»Ÿä¸€åŠ è½½è‡ªåŠ¨é…ç½®ã€Initializerã€Listener ç­‰ SPIã€‚</li>
                    <li>å¯åŠ¨äº‹ä»¶åºåˆ—ï¼šApplicationStarting â†’ EnvironmentPrepared â†’ Prepared â†’ Started â†’ Readyã€‚</li>
                </ul>
            </div>
            <div class="description">
                <h3>ä»£ç ç¤ºä¾‹ï¼šåº”ç”¨å¯åŠ¨ç±»ä¸ ApplicationRunner</h3>
                <pre><code class="language-java">import org.springframework.boot.CommandLineRunner;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;

@SpringBootApplication
public class DemoApplication {
    public static void main(String[] args) {
        SpringApplication.run(DemoApplication.class, args);
    }

    @Bean
    public CommandLineRunner init() {
        return args -&gt; System.out.println("Application started. Init data...");
    }
}</code></pre>
            </div>
        </div>

        <!-- Section 12 -->
        <div class="diagram-section" id="spring-autoconfig">
            <h2>12. è‡ªåŠ¨é…ç½®ç­›é€‰ä¸ç”Ÿæ•ˆæµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
graph TD
    A[SpringFactoriesLoader<br/>è¯»å– META-INF/spring.factories] --> B[AutoConfigurationImportSelector]
    B --> C[åŠ è½½æ‰€æœ‰å€™é€‰ auto-configurations]
    C --> D[æ’é™¤ @EnableAutoConfiguration é…ç½®]
    D --> E[è¿‡æ»¤ spring.autoconfigure.exclude]
    E --> F[åº”ç”¨ AutoConfigurationImportFilter<br/>æ¡ä»¶è¿‡æ»¤]
    F --> G[å¤„ç†æ¡ä»¶æ³¨è§£ä¸å±æ€§]
    G --> H[æœ€ç»ˆå¯¼å…¥çš„è‡ªåŠ¨é…ç½®ç±»]
    H --> I[æ³¨å†Œ BeanDefinition]

    style H fill:#4db6ac,color:#fff
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <ul>
                    <li>æ¡ä»¶æ³¨è§£ï¼ˆConditionalOnClassã€OnMissingBeanã€OnProperty ç­‰ï¼‰å†³å®šè‡ªåŠ¨é…ç½®æ˜¯å¦ç”Ÿæ•ˆã€‚</li>
                    <li>AutoConfigurationReportLoggingInitializer å¯è¾“å‡ºè‡ªåŠ¨é…ç½®å¯ç”¨/å¤±æ•ˆçš„åŸå› ã€‚</li>
                </ul>
            </div>
        </div>

        <!-- Section 13 -->
        <div class="diagram-section" id="spring-events">
            <h2>13. åº”ç”¨äº‹ä»¶å‘å¸ƒä¸ç›‘å¬æœºåˆ¶</h2>
            <div class="diagram-container">
                <div class="mermaid">
sequenceDiagram
    participant Publisher as ApplicationEventPublisher
    participant Multicaster as ApplicationEventMulticaster
    participant Listener1 as ApplicationListener&lt;A&gt;
    participant Listener2 as ApplicationListener&lt;B&gt;
    participant Listener3 as @EventListener

    Publisher->>Multicaster: publishEvent(event)
    Multicaster->>Listener1: onApplicationEvent (å¼‚æ­¥/åŒæ­¥)
    Multicaster->>Listener2: onApplicationEvent
    Multicaster->>Listener3: è°ƒç”¨æ ‡æ³¨æ–¹æ³•
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <ul>
                    <li>SimpleApplicationEventMulticaster é»˜è®¤åŒæ­¥æ‰§è¡Œï¼Œå¯é…ç½® TaskExecutor å˜ä¸ºå¼‚æ­¥æ¨¡å¼ã€‚</li>
                    <li>@TransactionalEventListener æ”¯æŒåœ¨äº‹åŠ¡æäº¤åå†è§¦å‘ç›‘å¬é€»è¾‘ã€‚</li>
                </ul>
            </div>
        </div>

        <!-- Section 14 -->
        <div class="diagram-section" id="spring-scheduling">
            <h2>14. è°ƒåº¦ä¸å¼‚æ­¥æ‰§è¡Œæµç¨‹</h2>
            <div class="diagram-container">
                <div class="mermaid">
flowchart TD
    Start[@EnableScheduling / @EnableAsync] --> Registrar[Registrar æ³¨å†Œåå¤„ç†å™¨]
    Registrar --> SchedulerProcessor[ScheduledAnnotationBeanPostProcessor]
    Registrar --> AsyncProcessor[AsyncAnnotationBeanPostProcessor]

    SchedulerProcessor --> ParseScheduled[è§£æ @Scheduled æ–¹æ³•]
    ParseScheduled --> RegisterTask[æ³¨å†Œåˆ° TaskScheduler]
    TaskScheduler --> ExecuteTask[æŒ‰ Cron / fixedDelay æ‰§è¡Œä»»åŠ¡]

    AsyncProcessor --> ParseAsync[è§£æ @Async æ–¹æ³•]
    ParseAsync --> WrapProxy[åˆ›å»ºä»£ç†åŒ…è£…æ–¹æ³•]
    WrapProxy --> SubmitExecutor[æäº¤åˆ° TaskExecutor]

    style ExecuteTask fill:#ffcc80
    style SubmitExecutor fill:#90caf9
                </div>
            </div>
            <div class="description">
                <h3>è¯´æ˜</h3>
                <ul>
                    <li>TaskScheduler é»˜è®¤å®ç°ä¸º ThreadPoolTaskSchedulerï¼Œå¯é€šè¿‡è‡ªå®šä¹‰ Bean è¦†ç›–ã€‚</li>
                    <li>@Async é»˜è®¤ä½¿ç”¨ SimpleAsyncTaskExecutorï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®é…ç½® ThreadPoolTaskExecutorã€‚</li>
                </ul>
            </div>
        </div>

        <!-- Section 15 -->
        <div class="diagram-section" id="spring-glossary">
            <h2>15. æ ¸å¿ƒæ¦‚å¿µé€Ÿè§ˆ</h2>
            <div class="description">
                <ul>
                    <li><strong>ApplicationContext</strong>ï¼šå®¹å™¨é¡¶å±‚æ¥å£ï¼Œæä¾› Bean ç®¡ç†ã€äº‹ä»¶ã€å›½é™…åŒ–ã€ç¯å¢ƒç­‰æ‰©å±•èƒ½åŠ›ã€‚</li>
                    <li><strong>BeanFactoryPostProcessor / BeanPostProcessor</strong>ï¼šåˆ†åˆ«ç”¨äºä¿®æ”¹ BeanDefinition ä¸ Bean å®ä¾‹çš„æ‰©å±•ç‚¹ã€‚</li>
                    <li><strong>SmartLifecycle</strong>ï¼šç”Ÿå‘½å‘¨æœŸæ‰©å±•æ¥å£ï¼Œæ”¯æŒåˆ†é˜¶æ®µå¯åŠ¨ä¸åœæ­¢ã€‚</li>
                    <li><strong>Resource / Environment / PropertySources</strong>ï¼šæä¾›ç»Ÿä¸€çš„é…ç½®å±æ€§è§£æèƒ½åŠ›ã€‚</li>
                    <li><strong>DispatcherServlet / DispatcherHandler</strong>ï¼šServlet MVC ä¸ WebFlux çš„è¯·æ±‚åˆ†å‘æ ¸å¿ƒã€‚</li>
                    <li><strong>PlatformTransactionManager</strong>ï¼šäº‹åŠ¡ç®¡ç†æŠ½è±¡ï¼Œæ•´åˆ JDBCã€JPAã€R2DBC ç­‰å®ç°ã€‚</li>
                    <li><strong>AutoConfiguration</strong>ï¼šSpring Boot æ¡ä»¶åŒ–é…ç½®æœºåˆ¶ï¼Œç»“åˆ SPI ä¸æ¡ä»¶æ³¨è§£ç”Ÿæ•ˆã€‚</li>
                </ul>
                <p style="margin-top: 16px;">âœ… å»ºè®®é…åˆ Spring å®˜æ–¹æ–‡æ¡£ã€æºç è°ƒè¯•é˜…è¯»ï¼Œä½¿ç”¨æ”¯æŒ Mermaid çš„ Markdown/HTML æŸ¥çœ‹å™¨å³å¯å³æ—¶æ¸²æŸ“ä»¥ä¸Šæµç¨‹å›¾ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        // ç¡®ä¿ Mermaid åº“å’Œ DOM éƒ½åŠ è½½å®Œæˆåå†åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({
                    startOnLoad: true,
                    theme: 'default',
                    securityLevel: 'loose',
                    flowchart: {
                        useMaxWidth: true,
                        htmlLabels: true,
                        curve: 'basis'
                    },
                    sequence: {
                        diagramMarginX: 50,
                        diagramMarginY: 16,
                        actorMargin: 50,
                        width: 150,
                        height: 65,
                        messageMargin: 40
                    }
                });
            } else {
                console.error('Mermaid åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ CDN é“¾æ¥');
                // å¤‡ç”¨ CDN
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/mermaid@10.9.1/dist/mermaid.min.js';
                script.onload = function() {
                    mermaid.initialize({
                        startOnLoad: true,
                        theme: 'default',
                        securityLevel: 'loose',
                        flowchart: {
                            useMaxWidth: true,
                            htmlLabels: true,
                            curve: 'basis'
                        },
                        sequence: {
                            diagramMarginX: 50,
                            diagramMarginY: 16,
                            actorMargin: 50,
                            width: 150,
                            height: 65,
                            messageMargin: 40
                        }
                    });
                };
                document.head.appendChild(script);
            }
        });
    </script>
</body>
</html>

